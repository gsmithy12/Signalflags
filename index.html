<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Maritime Signals Mastery</title>
<style>
/* --- CSS VARIABLES & RESET --- */
:root {
    --text-main: #ffffff;
    --text-muted: #cbd5e1;
    --accent: #0ea5e9;       /* Sky Blue */
    --accent-glow: rgba(14, 165, 233, 0.4);
    --success: #4ade80;      /* Green */
    --error: #f87171;        /* Red */
    --gold: #facc15;         /* Gold */
    --glass-bg: rgba(30, 41, 59, 0.95);
    --glass-border: rgba(255, 255, 255, 0.1);
    --glass-blur: 24px;
    --radius: 16px;
}

* { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; -webkit-tap-highlight-color: transparent; }

/* --- ANIMATED BACKGROUND --- */
body {
    background-color: #0f172a;
    background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
    background-attachment: fixed;
    background-size: cover;
    color: var(--text-main);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    overflow-x: hidden;
    user-select: none;
}

/* --- LAYOUT UTILS --- */
.container { width: 100%; max-width: 800px; margin: 0 auto; position: relative; z-index: 1; }
.hidden { display: none !important; }

h1 { 
    font-size: 2.2rem; 
    font-weight: 800;
    text-align: center; 
    margin-bottom: 0.5rem;
    background: linear-gradient(to right, #38bdf8, #818cf8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-transform: uppercase; 
    letter-spacing: 2px; 
    text-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

h3 { margin-bottom: 1rem; text-align: center; }

/* --- GLASS CARDS --- */
.card {
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    margin-bottom: 1.5rem;
    transition: transform 0.3s ease;
}

/* --- HOME SCREEN --- */
.mode-select-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 30px;
}
.big-mode-btn {
    background: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: var(--radius);
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
    position: relative;
}
.big-mode-btn:hover {
    transform: translateY(-5px);
    background: linear-gradient(145deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
    border-color: var(--accent);
    box-shadow: 0 10px 30px rgba(14, 165, 233, 0.2);
}

.big-mode-icon { font-size: 3rem; margin-bottom: 10px; }
.big-mode-title { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
.big-mode-desc { color: var(--text-muted); font-size: 0.9rem; }
.pass-mark-badge {
    background: rgba(14, 165, 233, 0.2);
    color: var(--accent);
    font-size: 0.8rem;
    font-weight: bold;
    padding: 4px 10px;
    border-radius: 12px;
    margin-top: 5px;
    border: 1px solid rgba(14, 165, 233, 0.3);
}

.footer-credit {
    margin-top: 30px;
    text-align: center;
    font-size: 0.8rem;
    color: var(--text-muted);
    letter-spacing: 1px;
    opacity: 0.7;
    text-transform: uppercase;
    font-weight: bold;
}

/* --- HUD DASHBOARD --- */
.hud-dashboard {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(10px);
    padding: 15px 20px;
    border-radius: var(--radius);
    border: 1px solid var(--glass-border);
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
.hud-top-row {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 0.9rem; color: var(--text-muted);
    border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px;
    text-transform: uppercase; letter-spacing: 1px;
}
.hud-stats-row {
    display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;
}
.stat-chip {
    display: flex; align-items: center; gap: 8px; padding: 8px 16px;
    border-radius: 50px; background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    font-size: 0.95rem; font-weight: 600;
}
.chip-streak.hot { 
    color: #fff; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.4)); 
    border-color: rgba(251, 191, 36, 0.5); 
    box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
    animation: pulse-gold 2s infinite;
}
@keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); } 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); } }
.chip-acc { color: var(--accent); }
.chip-wpm { color: var(--gold); border-color: rgba(251, 191, 36, 0.3); }

/* --- FLAG STAGE --- */
.flag-stage {
    display: flex; justify-content: center; align-items: center;
    margin: 1rem 0 2rem 0; min-height: 240px;
    background: radial-gradient(circle at center, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.95));
    border-radius: var(--radius); padding: 20px; position: relative;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
}
.flag-stage svg { height: 180px; width: auto; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
.complement-text {
    position: absolute; bottom: 15px; right: 15px;
    background: rgba(0,0,0,0.8); padding: 6px 12px; border-radius: 8px;
    font-size: 0.9rem; font-weight: bold; color: var(--gold); border: 1px solid rgba(255,255,255,0.1);
}

/* --- MORSE STAGE --- */
.morse-stage {
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    margin: 1rem 0 2rem 0; min-height: 240px;
    background: radial-gradient(circle at center, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.95));
    border-radius: var(--radius); padding: 20px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
}
.morse-big-char { font-size: 6rem; font-weight: 900; color: var(--text-main); text-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 10px; }
.morse-display-code { 
    font-family: monospace; font-size: 2rem; letter-spacing: 5px; 
    background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 8px; 
    min-width: 150px; text-align: center; border: 1px solid rgba(255,255,255,0.1);
    min-height: 60px; color: var(--accent);
}

/* --- PROSIGNS DISPLAY --- */
.prosigns-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    margin-top: 10px;
}
.prosigns-table th {
    text-align: left;
    color: var(--accent);
    text-transform: uppercase;
    font-size: 0.9rem;
    padding: 0 15px;
}
.prosigns-table tr.row-item {
    background: rgba(255,255,255,0.05);
}
.prosigns-table td {
    padding: 15px;
    border-top: 1px solid rgba(255,255,255,0.05);
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.prosigns-table td:first-child {
    border-left: 1px solid rgba(255,255,255,0.05);
    border-top-left-radius: 10px;
    border-bottom-left-radius: 10px;
    font-weight: bold;
    color: var(--gold);
    width: 30%;
    font-family: monospace;
    font-size: 1.1rem;
}
.prosigns-table td:last-child {
    border-right: 1px solid rgba(255,255,255,0.05);
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
    color: var(--text-main);
}

.overbar {
    text-decoration: overline;
    text-decoration-thickness: 2px;
    text-decoration-color: var(--accent);
}

/* Prosigns Game Specifics */
.prosign-stage {
    display: flex; justify-content: center; align-items: center;
    margin: 1rem 0 2rem 0; min-height: 240px;
    background: radial-gradient(circle at center, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.95));
    border-radius: var(--radius); padding: 20px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
}
.prosign-big-text {
    font-size: 4rem; font-weight: 800; color: var(--text-main);
    letter-spacing: 3px; text-shadow: 0 4px 10px rgba(0,0,0,0.5);
    font-family: monospace;
}

/* --- KEYER BUTTONS --- */
.keyer-btn-base {
    width: 100%; height: 100px;
    background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
    color: var(--text-main); font-size: 1.2rem; font-weight: bold;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
    transition: all 0.1s; position: relative; overflow: hidden;
    margin-top: 20px;
    touch-action: manipulation;
}
.keyer-btn-base:active, .keyer-btn-base.pressed { background: rgba(255,255,255,0.15); transform: scale(0.98); border-color: var(--accent); }
#keyer-sub { font-size: 0.8rem; opacity: 0.7; margin-top: 5px; font-weight: normal; }
.press-progress {
    width: 100%; height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; margin-top: 15px; overflow: hidden;
}
.press-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0s; }

/* --- INPUTS --- */
input[type="text"] {
    width: 100%; padding: 16px; padding-right: 40px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1);
    background: rgba(15, 23, 42, 0.8); color: white; font-size: 1.1rem; outline: none; margin-bottom: 10px; transition: border 0.3s;
}
input[type="text"]:focus { border-color: var(--accent); }
input[type="text"]:disabled { background: rgba(0,0,0,0.5); color: #aaa; }

/* --- EXAM SPECIFIC STYLES --- */
.progress-bar {
    width: 100%; height: 8px; background: rgba(255,255,255,0.1); border-radius: 4px; margin-bottom: 20px; overflow: hidden;
}
.progress-fill {
    height: 100%; background: var(--accent); width: 0%; transition: width 0.5s ease;
}

.exam-section-title { color: var(--accent); text-transform: uppercase; font-size: 0.9rem; margin-bottom: 10px; letter-spacing: 1px; font-weight: bold; }
.exam-status { text-align: center; margin-bottom: 20px; font-size: 1.1rem; color: var(--text-muted); }

/* EXAM SIGNAL LIGHT */
.signal-light {
    width: 120px; height: 120px; background: #333; border-radius: 50%;
    margin: 0 auto 30px auto; border: 4px solid #555;
    box-shadow: inset 0 0 20px #000;
    transition: background 0.05s;
}
.signal-light.lit {
    background: #fff;
    box-shadow: 0 0 50px #fff, inset 0 0 10px #fff;
    border-color: #fff;
}

/* EXAM QUESTIONS */
.theory-q { margin-bottom: 20px; border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 20px; }
.theory-q label { display: block; margin-bottom: 10px; font-weight: bold; color: var(--text-main); }

/* EXAM FEEDBACK */
.input-wrapper { position: relative; margin-bottom: 5px; }
.status-icon {
    position: absolute; right: 15px; top: 50%; transform: translateY(-50%);
    font-size: 1.2rem; pointer-events: none;
}
.border-correct { border-color: var(--success) !important; box-shadow: 0 0 8px rgba(74, 222, 128, 0.3); }
.border-wrong { border-color: var(--error) !important; box-shadow: 0 0 8px rgba(248, 113, 113, 0.3); }
.feedback-msg { color: var(--error); font-size: 0.9rem; margin-bottom: 20px; padding-left: 5px; font-weight: bold; }
.feedback-box { margin-top: 20px; padding: 15px; border-radius: 10px; background: rgba(0,0,0,0.3); text-align: center; }
.pass-text { color: var(--success); font-weight: bold; font-size: 1.2rem; }
.fail-text { color: var(--error); font-weight: bold; font-size: 1.2rem; }

/* EXAM SENDING DISPLAY */
.send-display-box {
    text-align: center; margin-top: 20px; 
    font-family: monospace; color: var(--accent); 
    min-height: 60px; font-size: 4rem; letter-spacing: 5px; 
    background: rgba(0,0,0,0.3); border-radius: 8px; padding: 10px;
    border: 1px solid rgba(255,255,255,0.1);
    transition: background 0.2s;
}
.send-display-box.flash-red {
    background: rgba(239, 68, 68, 0.4); border-color: var(--error);
}
.live-dots { font-size: 1rem; color: var(--text-muted); min-height: 20px; margin-top: 5px; }

/* EXAM COMPARISON */
.comparison-container {
    display: flex; flex-direction: column; gap: 10px; margin-top: 15px; background: rgba(0,0,0,0.2); padding: 10px; border-radius: 8px;
}
.comp-row { display: flex; justify-content: center; gap: 5px; font-family: monospace; font-size: 1.2rem; flex-wrap: wrap; }
.char-box { 
    width: 30px; height: 40px; display: flex; align-items: center; justify-content: center; 
    border-radius: 4px; background: rgba(255,255,255,0.05); font-weight: bold;
}
.char-correct { color: #0f172a; background: var(--success); }
.char-wrong { color: #0f172a; background: var(--error); }
.char-miss { color: var(--text-muted); border: 1px dashed var(--text-muted); opacity: 0.5; }
.label-row { font-size: 0.8rem; color: var(--text-muted); margin-bottom: -5px; text-align: left; margin-left: 10px;}

.skip-btn-container { position: absolute; top: 20px; right: 20px; }

/* --- GENERIC UI ELEMENTS --- */
.grid-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
.option-btn {
    background: linear-gradient(145deg, rgba(255,255,255,0.07) 0%, rgba(255,255,255,0.03) 100%);
    backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08);
    color: var(--text-main); padding: 16px 20px; border-radius: 12px;
    text-align: left; cursor: pointer; display: flex; align-items: center; transition: all 0.2s;
}
.option-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); border-color: var(--accent); }
.option-btn.correct { background: rgba(74, 222, 128, 0.25); border-color: var(--success); }
.option-btn.wrong { background: rgba(248, 113, 113, 0.25); border-color: var(--error); }

.btn {
    display: inline-block; background: linear-gradient(135deg, #38bdf8 0%, #0284c7 100%);
    color: white; border: none; padding: 12px 28px; font-size: 1rem; font-weight: 700;
    border-radius: 50px; cursor: pointer; transition: all 0.3s; text-transform: uppercase;
    box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
    touch-action: manipulation; margin: 5px;
}
.btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
.btn-outline { background: transparent; border: 2px solid rgba(56, 189, 248, 0.5); color: var(--accent); box-shadow: none; }
.btn-outline:hover { background: rgba(56, 189, 248, 0.1); border-color: var(--accent); }
.btn-danger { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
.btn-success { background: linear-gradient(135deg, #22c55e 0%, #15803d 100%); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); }

.pill-selector { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
.pill {
    padding: 10px 18px; background: rgba(255,255,255,0.05); border-radius: 20px;
    cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; font-size: 0.9rem;
}
.pill.active { background: var(--accent); color: #0f172a; font-weight: 700; border-color: var(--accent); }
.settings-group { margin-bottom: 25px; }
.settings-group label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; }

/* --- MORSE BUTTON GRID --- */
.morse-tap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; width: 100%; }
.morse-tap-btn { font-size: 2rem; padding: 20px; font-weight: bold; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; cursor: pointer; user-select: none; touch-action: manipulation; }
.morse-tap-btn:active { background: var(--accent); color: #0f172a; }

.keyer-btn-base, #keyer-btn {
    width: 100%; height: 120px;
    background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
    color: var(--text-main); font-size: 1.5rem; font-weight: bold;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
    transition: all 0.1s; position: relative; overflow: hidden;
    margin-top: 20px; touch-action: manipulation;
}
.keyer-btn-base:active, .keyer-btn-base.pressed, #keyer-btn.pressed { background: rgba(255,255,255,0.15); transform: scale(0.98); border-color: var(--accent); }
#keyer-sub { font-size: 0.8rem; opacity: 0.7; margin-top: 5px; font-weight: normal; }
.press-progress {
    width: 100%; height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; margin-top: 15px; overflow: hidden;
}
.press-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0s; }

.feedback-text { text-align: center; height: 30px; font-weight: bold; margin-top: 15px; font-size: 1.1rem; }
.nav-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }

/* --- RESULTS PAGE STYLES --- */
.result-item {
    display: flex; align-items: center; gap: 15px;
    background: rgba(255,255,255,0.03);
    padding: 12px; margin-bottom: 10px;
    border-radius: 10px;
    border-left: 4px solid var(--text-muted);
}
.result-item.r-correct { border-left-color: var(--success); background: linear-gradient(90deg, rgba(74,222,128,0.05) 0%, transparent 100%); }
.result-item.r-wrong { border-left-color: var(--error); background: linear-gradient(90deg, rgba(248,113,113,0.05) 0%, transparent 100%); }

.result-mini-flag svg { height: 40px; width: auto; display: block; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
.result-mini-morse, .result-mini-prosign { 
    width: 50px; height: 40px; display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: 1.1rem; color: var(--accent); background: rgba(255,255,255,0.05);
    border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
}
.result-info { flex: 1; font-size: 0.95rem; }
.result-info .user-ans { font-style: italic; color: var(--error); font-size: 0.85rem; margin-top: 2px; }
.result-info .real-ans { color: var(--success); font-size: 0.85rem; font-weight: 600; }

.typing-feedback { margin-top: 15px; padding: 15px; border-radius: 8px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); }

/* --- MOBILE & RESPONSIVE TWEAKS --- */
@media (max-width: 600px) {
    h1 { font-size: 1.8rem; }
    .card { padding: 1.25rem; margin-bottom: 1rem; }
    .container { padding: 10px; }
    
    .mode-select-grid { gap: 10px; }
    .big-mode-btn { padding: 15px; }
    .big-mode-icon { font-size: 2rem; margin-bottom: 5px; }
    .big-mode-title { font-size: 1.1rem; }
    .big-mode-desc { font-size: 0.8rem; }
    
    .flag-stage, .morse-stage, .prosign-stage { min-height: 180px; padding: 10px; }
    .flag-stage svg { height: 120px; }
    .morse-big-char, .prosign-big-text { font-size: 4rem; }
    .send-display-box { font-size: 2.5rem; min-height: 50px; }
    
    .signal-light { width: 80px; height: 80px; margin-bottom: 15px; }
    .keyer-btn-base, #keyer-btn { height: 100px; margin-top: 10px; }
    .skip-btn-container { top: 10px; right: 10px; }
    .skip-btn-container .btn { padding: 5px 10px; font-size: 0.75rem; }
    
    .hud-stats-row { gap: 8px; }
    .stat-chip { padding: 6px 10px; font-size: 0.85rem; }
    .grid-options { grid-template-columns: 1fr; } 
    .option-btn { padding: 12px 15px; font-size: 0.95rem; }
}
</style>
</head>
<body>

<div class="container" id="app">

    <div id="screen-home" class="card">
        <h1>Maritime Mastery</h1>
        <p style="text-align:center; color: var(--text-muted); margin-bottom:10px;">Learn International Signals</p>
        
        <div class="mode-select-grid">
            <div class="big-mode-btn" onclick="goToFlagSetup()">
                <div class="big-mode-icon">üö©</div>
                <div class="big-mode-title">Flags</div>
                <div class="big-mode-desc">Visual quiz</div>
            </div>
            <div class="big-mode-btn" onclick="goToMorseSetup()">
                <div class="big-mode-icon">üì°</div>
                <div class="big-mode-title">Morse</div>
                <div class="big-mode-desc">Tap & Keyer</div>
            </div>
            <div class="big-mode-btn" onclick="goToProsigns()">
                <div class="big-mode-icon">üìñ</div>
                <div class="big-mode-title">Prosigns</div>
                <div class="big-mode-desc">Procedure Reference</div>
            </div>
            <div class="big-mode-btn" onclick="goToExam()">
                <div class="big-mode-icon">üéì</div>
                <div class="big-mode-title">Final Exam</div>
                <div class="big-mode-desc">Comprehensive Test</div>
                <div class="pass-mark-badge">Pass Mark: 90%</div>
            </div>
        </div>

        <div class="footer-credit">MADE BY GEORGE</div>
    </div>

    <div id="screen-flags-setup" class="card hidden">
        <h3>Flag Quiz Setup</h3>
        <div class="settings-group">
            <label>Mode</label>
            <div class="pill-selector" id="flag-mode-selector">
                <div class="pill active" onclick="setFlagMode('CHAR')">Identify Flag</div>
                <div class="pill" onclick="setFlagMode('MEANING_MC')">Meaning (MC)</div>
                <div class="pill" onclick="setFlagMode('MEANING_TYPE')">Meaning (Type)</div>
                <div class="pill" onclick="setFlagMode('SECONDARY')">Secondary Meanings</div>
            </div>
        </div>
        <div class="settings-group" id="flag-cats-group">
            <label>Categories</label>
            <div class="pill-selector">
                <div class="pill active pill-check" onclick="toggleFlagCat('letters', this)">Letters</div>
                <div class="pill pill-check" onclick="toggleFlagCat('numerals', this)">Numerals</div>
                <div class="pill pill-check" onclick="toggleFlagCat('subs', this)">Substitutes</div>
            </div>
        </div>
        <div class="settings-group">
            <label>Options</label>
            <div class="pill-selector">
                <div id="btn-flag-autonext" class="pill" onclick="toggleFlagAutoNext()">Auto-Next: OFF</div>
            </div>
        </div>
        <div class="settings-group">
            <label>Count</label>
            <div class="pill-selector" id="flag-count-selector">
                <div class="pill active" onclick="setFlagCount(10)">10</div>
                <div class="pill" onclick="setFlagCount(20)">20</div>
                <div class="pill" onclick="setFlagCount(999)">Endless</div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 40px; display:flex; justify-content:center; gap:15px;">
            <button class="btn btn-outline" onclick="goHome()">Back</button>
            <button class="btn" onclick="startFlagGame()">Start Quiz</button>
        </div>
    </div>

    <div id="screen-flags-game" class="hidden">
        <div class="hud-dashboard">
            <div class="hud-top-row">
                <span id="flag-hud-progress">Question 1/10</span>
                <span>FLAGS</span>
            </div>
            <div class="hud-stats-row">
                <div id="flag-chip-streak" class="stat-chip chip-streak"><span>üî•</span><span id="flag-val-streak">0</span></div>
                <div class="stat-chip chip-acc"><span>üéØ</span><span id="flag-val-acc">100%</span></div>
            </div>
        </div>
        <div class="card">
            <div class="flag-stage" id="flag-stage">
                <div id="complement-badge" class="complement-text hidden"></div>
            </div>
            <div id="flag-q-text" style="text-align:center; margin-bottom:20px; font-weight:bold; font-size:1.1rem; color:var(--text-muted);">Identify this signal</div>
            <div id="flag-options-grid" class="grid-options hidden"></div>
            <div id="flag-typing-area" class="hidden">
                <input type="text" id="flag-type-input" placeholder="Type meaning here..." autocomplete="off">
                <div style="text-align:center; margin-top:10px;">
                    <button class="btn" onclick="submitFlagType()">Submit</button>
                </div>
                <div id="flag-feedback-box" class="hidden typing-feedback"></div>
            </div>
            <div id="flag-controls" class="nav-buttons hidden">
                <button class="btn btn-outline" onclick="nextFlagQ()">Next Question</button>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-danger" onclick="endGame('flags')">Finish & Review</button>
        </div>
    </div>

    <div id="screen-morse-setup" class="card hidden">
        <h3>Morse Trainer Setup</h3>
        <div class="settings-group">
            <label>Input Mode</label>
            <div class="pill-selector" id="morse-mode-selector">
                <div class="pill active" onclick="setMorseMode('tap')">Tap Buttons</div>
                <div class="pill" onclick="setMorseMode('send')">Send (Keyer)</div>
            </div>
        </div>
        <div class="settings-group">
            <label>Character Set</label>
            <div class="pill-selector" id="morse-set-selector">
                <div class="pill active" onclick="setMorseSet('limited')">Easy (X Y Z F Q L J)</div>
                <div class="pill" onclick="setMorseSet('nums')">Numbers</div>
                <div class="pill" onclick="setMorseSet('all')">All Letters</div>
            </div>
        </div>
        <div class="settings-group">
            <label>Options</label>
            <div class="pill-selector">
                <div id="btn-morse-autonext" class="pill" onclick="toggleMorseAutoNext()">Auto-Next: OFF</div>
                <div id="btn-morse-sound" class="pill active" onclick="toggleMorseSound()">Sound: ON</div>
            </div>
        </div>
        <div style="text-align: center; margin-top: 40px; display:flex; justify-content:center; gap:15px;">
            <button class="btn btn-outline" onclick="goHome()">Back</button>
            <button class="btn" onclick="startMorseGame()">Start Practice</button>
        </div>
    </div>

    <div id="screen-morse-game" class="hidden">
        <div class="hud-dashboard">
            <div class="hud-top-row">
                <span>MORSE PRACTICE</span>
                <span id="morse-mode-label" style="color:var(--accent);">TAP MODE</span>
            </div>
            <div class="hud-stats-row">
                <div id="morse-chip-streak" class="stat-chip chip-streak"><span>üî•</span><span id="morse-val-streak">0</span></div>
                <div id="morse-chip-wpm" class="stat-chip chip-wpm hidden"><span>üì∂</span><span id="morse-val-wpm">-- WPM</span></div>
            </div>
        </div>
        <div class="card">
            <div class="morse-stage">
                <div id="morse-target-char" class="morse-big-char">?</div>
                <div id="morse-user-input" class="morse-display-code"></div>
            </div>
            <div id="morse-tap-controls" class="hidden">
                <div class="morse-tap-grid">
                    <button class="morse-tap-btn" onmousedown="tapDot(event)" ontouchstart="tapDot(event)">‚óè</button>
                    <button class="morse-tap-btn" onmousedown="tapDash(event)" ontouchstart="tapDash(event)">‚ñ¨</button>
                </div>
            </div>
            <div id="morse-send-controls" class="hidden">
                <div id="keyer-btn" class="keyer-btn-base">
                    KEY
                    <div id="keyer-sub">Hold for Dash</div>
                    <div class="press-progress"><div id="press-bar" class="press-bar"></div></div>
                </div>
            </div>
            <div id="morse-feedback" class="feedback-text"></div>
            <div class="nav-buttons" id="morse-nav-area">
                <button class="btn btn-outline" onclick="morseBackspace()">Back</button>
                <button class="btn btn-outline" onclick="morseClear()">Clear</button>
                <button id="btn-morse-check" class="btn" onclick="checkMorse()">Check</button>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-danger" onclick="endGame('morse')">Finish & Review</button>
        </div>
    </div>

    <div id="screen-prosigns" class="card hidden">
        <h3>Procedure Signals</h3>
        <table class="prosigns-table" id="prosigns-table">
            <thead>
                <tr><th>Signal</th><th>Meaning</th></tr>
            </thead>
            <tbody id="prosigns-tbody"></tbody>
        </table>
        <div style="text-align: center; margin-top: 30px; display:flex; flex-direction:column; gap:10px;">
            <button class="btn btn-success" style="width:100%;" onclick="startProsignsGame()">Start Prosigns Quiz</button>
            <button class="btn btn-outline" style="width:100%;" onclick="goHome()">Back to Menu</button>
        </div>
    </div>

    <div id="screen-prosigns-game" class="hidden">
        <div class="hud-dashboard">
            <div class="hud-top-row">
                <span id="pro-hud-progress">1/10</span>
                <span>PROSIGNS</span>
            </div>
            <div class="hud-stats-row">
                <div id="pro-chip-streak" class="stat-chip chip-streak"><span>üî•</span><span id="pro-val-streak">0</span></div>
            </div>
        </div>
        <div class="card">
            <div class="prosign-stage">
                <div id="prosign-display" class="prosign-big-text">AA</div>
            </div>
            <div style="text-align:center; margin-bottom:20px; font-weight:bold; font-size:1.1rem; color:var(--text-muted);">
                What does this signal mean?
            </div>
            <div id="pro-options-grid" class="grid-options"></div>
            <div id="pro-controls" class="nav-buttons hidden">
                <button class="btn btn-outline" onclick="nextProsignQ()">Next Question</button>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-danger" onclick="endGame('prosigns')">Finish & Review</button>
        </div>
    </div>

    <div id="screen-exam" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                <h2 style="margin:0; color:var(--accent);">Final Exam</h2>
                <div style="display:flex; gap:10px;">
                    <div class="skip-btn-container" style="position:static;">
                        <button class="btn btn-outline" onclick="skipExamSection()">Skip</button>
                    </div>
                    <button class="btn btn-outline" onclick="goHome()">Exit</button>
                </div>
            </div>
            <div class="progress-bar"><div id="exam-main-progress" class="progress-fill"></div></div>
            <div id="exam-status" class="exam-status">Section 1 of 4</div>
            <div id="exam-content"></div>
        </div>
    </div>

    <div id="screen-results" class="card hidden">
        <h1>Results</h1>
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 4rem; font-weight: 800; color: var(--accent); text-shadow: 0 0 20px rgba(14,165,233,0.5);" id="final-score-percent">0%</div>
            <div style="color: var(--text-muted); font-size: 1.2rem;" id="final-score-text">0 out of 0 correct</div>
        </div>
        <h3 style="text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Review</h3>
        <div id="review-list"></div>
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="goHome()">Back to Menu</button>
        </div>
    </div>

</div>

<script>
// --- AUDIO ENGINE ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
let osc = null;
let gainNode = null;

function initAudio() {
    if (!audioCtx) { audioCtx = new AudioContext(); }
    if (audioCtx.state === 'suspended') { audioCtx.resume(); }
}

function playTone() {
    if (!appState.morse.soundEnabled) return;
    initAudio();
    if (osc) return; 
    osc = audioCtx.createOscillator();
    gainNode = audioCtx.createGain();
    osc.type = 'sine';
    osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01); 
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    osc.start();
}

function stopTone() {
    if (osc) {
        const now = audioCtx.currentTime;
        gainNode.gain.cancelScheduledValues(now);
        gainNode.gain.setValueAtTime(gainNode.gain.value, now);
        gainNode.gain.linearRampToValueAtTime(0, now + 0.01); 
        osc.stop(now + 0.01);
        osc = null;
    }
}

function playBeep(duration) {
    if (!appState.morse.soundEnabled) return;
    initAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = 600;
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + (duration / 1000));
}

// --- GLOBAL STATE ---
let appState = {
    screen: 'HOME',
    flags: { mode: 'CHAR', cats: { letters: true, numerals: false, subs: false }, count: 10, autoNext: false, qList: [], currIdx: 0, score: 0, streak: 0, waiting: false, history: [] },
    morse: { mode: 'tap', set: 'limited', autoNext: false, soundEnabled: true, pool: [], target: '', typed: '', streak: 0, ditEma: null, pressStart: 0, pressActive: false, waiting: false, history: [], correctCount: 0, wrongCount: 0 },
    prosigns: { qList: [], currIdx: 0, score: 0, streak: 0, waiting: false, history: [] },
    exam: { section: 1, scores: { 1:0, 2:0, 3:0, 4:0 }, maxScores: { 1:20, 2:10, 3:10, 4:10 }, sectionData: {}, skipped: false }
};

function hideAllScreens() {
    ['screen-home', 'screen-flags-setup', 'screen-flags-game', 'screen-morse-setup', 'screen-morse-game', 'screen-prosigns', 'screen-prosigns-game', 'screen-results', 'screen-exam'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
}

function goHome() {
    hideAllScreens();
    document.getElementById('screen-home').classList.remove('hidden');
    if(pressAnim) cancelAnimationFrame(pressAnim);
    stopTone();
}

// --- DATA ---
const DATA_LETTERS = {
    "A": { labelLong: "A ‚Äî Alpha", labelShort: "Alpha", primary: "I have a diver down; keep well clear at slow speed." },
    "B": { labelLong: "B ‚Äî Bravo", labelShort: "Bravo", primary: "I am taking in, or discharging or carrying dangerous goods." },
    "C": { labelLong: "C ‚Äî Charlie", labelShort: "Charlie", primary: "Yes (Affirmative)." },
    "D": { labelLong: "D ‚Äî Delta", labelShort: "Delta", primary: "Keep clear of me; I am manoeuvring with difficulty." },
    "E": { labelLong: "E ‚Äî Echo", labelShort: "Echo", primary: "I am altering my course to Starboard." },
    "F": { labelLong: "F ‚Äî Foxtrot", labelShort: "Foxtrot", primary: "I am disabled; communicate with me." },
    "G": { labelLong: "G ‚Äî Golf", labelShort: "Golf", primary: "I require a pilot. (Fishing: I am hauling nets)." },
    "H": { labelLong: "H ‚Äî Hotel", labelShort: "Hotel", primary: "I have a pilot on board." },
    "I": { labelLong: "I ‚Äî India", labelShort: "India", primary: "I am altering my course to Port." },
    "J": { labelLong: "J ‚Äî Juliet", labelShort: "Juliet", primary: "Keep clear of me. I am on fire and have dangerous cargo on board." },
    "K": { labelLong: "K ‚Äî Kilo", labelShort: "Kilo", primary: "I wish to communicate with you." },
    "L": { labelLong: "L ‚Äî Lima", labelShort: "Lima", primary: "You should stop your vessel instantly." },
    "M": { labelLong: "M ‚Äî Mike", labelShort: "Mike", primary: "My vessel is stopped and making no way through the water." },
    "N": { labelLong: "N ‚Äî November", labelShort: "November", primary: "No (Negative)." },
    "O": { labelLong: "O ‚Äî Oscar", labelShort: "Oscar", primary: "Man overboard." },
    "P": { labelLong: "P ‚Äî Papa", labelShort: "Papa", primary: "In Harbour: All persons should report on board. (Fishing: Nets caught)." },
    "Q": { labelLong: "Q ‚Äî Quebec", labelShort: "Quebec", primary: "My vessel is healthy and I request free pratique." },
    "R": { labelLong: "R ‚Äî Romeo", labelShort: "Romeo", primary: "No single letter meaning." },
    "S": { labelLong: "S ‚Äî Sierra", labelShort: "Sierra", primary: "I am operating astern propulsion." },
    "T": { labelLong: "T ‚Äî Tango", labelShort: "Tango", primary: "Keep clear of me; I am engaged in pair trawling." },
    "U": { labelLong: "U ‚Äî Uniform", labelShort: "Uniform", primary: "You are running into danger." },
    "V": { labelLong: "V ‚Äî Victor", labelShort: "Victor", primary: "I require assistance." },
    "W": { labelLong: "W ‚Äî Whiskey", labelShort: "Whiskey", primary: "I require medical assistance." },
    "X": { labelLong: "X ‚Äî X-ray", labelShort: "X-ray", primary: "Stop carrying out your intentions and watch for my signals." },
    "Y": { labelLong: "Y ‚Äî Yankee", labelShort: "Yankee", primary: "I am dragging my anchor." },
    "Z": { labelLong: "Z ‚Äî Zulu", labelShort: "Zulu", primary: "I require a tug. (Fishing: I am shooting nets)." }
};
const DATA_NUMERALS = { "0": { labelLong: "0 ‚Äî Numeral Zero", labelShort: "Zero", primary: "Numeral 0" }, "1": { labelLong: "1 ‚Äî Numeral One", labelShort: "One", primary: "Numeral 1" }, "2": { labelLong: "2 ‚Äî Numeral Two", labelShort: "Two", primary: "Numeral 2" }, "3": { labelLong: "3 ‚Äî Numeral Three", labelShort: "Three", primary: "Numeral 3" }, "4": { labelLong: "4 ‚Äî Numeral Four", labelShort: "Four", primary: "Numeral 4" }, "5": { labelLong: "5 ‚Äî Numeral Five", labelShort: "Five", primary: "Numeral 5" }, "6": { labelLong: "6 ‚Äî Numeral Six", labelShort: "Six", primary: "Numeral 6" }, "7": { labelLong: "7 ‚Äî Numeral Seven", labelShort: "Seven", primary: "Numeral 7" }, "8": { labelLong: "8 ‚Äî Numeral Eight", labelShort: "Eight", primary: "Numeral 8" }, "9": { labelLong: "9 ‚Äî Numeral Nine", labelShort: "Nine", primary: "Numeral 9" } };
const DATA_SUBS = { "SUB1": { labelLong: "1st Substitute", labelShort: "1st Sub", primary: "Repeats the uppermost signal flag of that class." }, "SUB2": { labelLong: "2nd Substitute", labelShort: "2nd Sub", primary: "Repeats the second flag of that class." }, "SUB3": { labelLong: "3rd Substitute", labelShort: "3rd Sub", primary: "Repeats the third flag of that class." }, "ANS": { labelLong: "Code and Answering Pendant", labelShort: "Ans Pendant", primary: "Decimal point or End of message." } };
const DATA_SECONDARY = [ { id: "A_sec", letter: "A", complement: "With 3 numerals", meaning: "AZIMUTH or BEARING" }, { id: "C_sec", letter: "C", complement: "(Alone)", meaning: "COURSE" }, { id: "D_sec", letter: "D", complement: "With 2, 4, or 6 numerals", meaning: "DATE" }, { id: "G_sec", letter: "G", complement: "With 4 or 5 numerals", meaning: "LONGITUDE" }, { id: "L_sec", letter: "L", complement: "With 4 numerals", meaning: "LATITUDE" }, { id: "R_sec", letter: "R", complement: "With 1 or more numerals", meaning: "DISTANCE (NM)" }, { id: "S_sec", letter: "S", complement: "With 1 or more numerals", meaning: "SPEED (Knots)" }, { id: "T_sec", letter: "T", complement: "With 4 numerals", meaning: "TIME (Local)" }, { id: "V_sec", letter: "V", complement: "With 1 or more numerals", meaning: "SPEED (Kph)" }, { id: "Z_sec", letter: "Z", complement: "With 4 numerals", meaning: "TIME (UTC/GMT)" }, { id: "G_fish", letter: "G", complement: "(Fishing)", meaning: "I am hauling nets" }, { id: "P_fish", letter: "P", complement: "(Fishing)", meaning: "My nets are caught fast" }, { id: "Z_fish", letter: "Z", complement: "(Fishing)", meaning: "I am shooting nets" } ];
const ALL_FLAGS = { ...DATA_LETTERS, ...DATA_NUMERALS, ...DATA_SUBS };
const MORSE_MAP = { "A": ".-", "B": "-...", "C": "-.-.", "D": "-..", "E": ".", "F": "..-.", "G": "--.", "H": "....", "I": "..", "J": ".---", "K": "-.-", "L": ".-..", "M": "--", "N": "-.", "O": "---", "P": ".--.", "Q": "--.-", "R": ".-.", "S": "...", "T": "-", "U": "..-", "V": "...-", "W": ".--", "X": "-..-", "Y": "-.--", "Z": "--..", "0": "-----", "1": ".----", "2": "..---", "3": "...--", "4": "....-", "5": ".....", "6": "-....", "7": "--...", "8": "---..", "9": "----." };
const LIMITED_LETTERS = ["X","Y","Z","F","Q","L","J"];
const NUMBERS_ARR = ["0","1","2","3","4","5","6","7","8","9"];
const ALL_LETTERS_ARR = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
const PROSIGNS = [ { code: "AA", bar: true, meaning: "Unknown station call / General call" }, { code: "EEEE", bar: false, meaning: "Erase (error)" }, { code: "AAA", bar: false, meaning: "Full stop / Decimal point" }, { code: "TTTT", bar: false, meaning: "Answering signal" }, { code: "T", bar: false, meaning: "Word or group received" }, { code: "AR", bar: true, meaning: "Ending signal / End of transmission" }, { code: "AS", bar: true, meaning: "Wait" }, { code: "DE", bar: false, meaning: "From... / This is..." }, { code: "K", bar: false, meaning: "Invitation to transmit" }, { code: "OK", bar: false, meaning: "It is correct" }, { code: "R", bar: false, meaning: "Received" }, { code: "RQ", bar: false, meaning: "Request / Question" }, { code: "RPT", bar: false, meaning: "Repeat (whole signal)" }, { code: "RPT AA", bar: false, meaning: "Repeat All After..." }, { code: "RPT AB", bar: false, meaning: "Repeat All Before..." }, { code: "RPT BN", bar: false, meaning: "Repeat All Between..." }, { code: "RPT WA", bar: false, meaning: "Repeat Word After..." }, { code: "RPT WB", bar: false, meaning: "Repeat Word Before..." } ];
const THEORY_POOL = [
    { q: "You sight flag Quebec with a ball above it. What does this mean?", a: ["distress"], display: "Distress" },
    { q: "You see flag Sierra with a ball underneath. What does this mean?", a: ["distress"], display: "Distress" },
    { q: "Decode: Z, 2, 1, 1st Sub, 2nd Sub.", a: ["z2121", "time2121", "2121"], display: "Z2121 (Time)" },
    { q: "In general terms, what is the code group ‚ÄòMCR‚Äô concerned with?", a: ["medical", "medicalsignalcode"], display: "Medical Signal Code" },
    { q: "What is a decimal point in Morse code?", a: ["aaa", ".-.-.-"], display: "AAA (or .-.-.-)" },
    { q: "What is the significance of the procedure signal ‚ÄòDE‚Äô?", a: ["from", "thisis"], display: "From (or This is)" },
    { q: "A fishing vessel has the Golf flag hoisted. What does this mean?", a: ["haulingnets", "hauling"], display: "Hauling nets" },
    { q: "What is the significance of the procedure group ‚ÄòRPT AB‚Äô?", a: ["repeatallbefore"], display: "Repeat all before" },
    { q: "Decode: D, 0, 2, 1st Sub, 3, 2nd Sub, 1.", a: ["d020321", "date020321", "020321"], display: "D020321 (Date)" },
    { q: "The following code message has been received ‚ÄòCY‚Ä¶.N‚Äô. What is the significance of the group ‚ÄòN‚Äô?", a: ["negative", "significanceofpreviousgroupshouldbereadinthenegative"], display: "Negative (Significance of previous group should be read in the negative)" },
    { q: "The following code message has been received ‚ÄòCY‚Ä¶.C‚Äô. What is the significance of the group ‚ÄòC‚Äô?", a: ["affirmative", "significanceofpreviousgroupshouldbereadintheaffirmative"], display: "Affirmative (Significance of previous group should be read in the affirmative)" },
    { q: "What is the significance of the procedure group ‚ÄòRPT BN‚Äô?", a: ["repeatallbetween"], display: "Repeat all between" },
    { q: "You have called another vessel by aldis lamp and they respond with ‚ÄòAS15‚Äô, what does this mean?", a: ["wait15minutes", "wait15mins", "wait15"], display: "Wait 15 minutes" },
    { q: "Decode the following flag hoist: A, 2, 5, 0, Code Pendant, 2nd Sub.", a: ["a250.2", "azimuth250.2"], display: "Azimuth 250.2¬∞" },
    { q: "Decode the following flag hoist: S, 1, 2, Code Pendant, 1st Sub.", a: ["s12.1", "speed12.1"], display: "Speed 12.1 knots" },
    { q: "Decode the following flag hoist: G, 1, 1st Sub, 2, 3rd Sub.", a: ["g1122", "longitude1122"], display: "Longitude 1122" },
    { q: "A warship has the code & signal pendant hoisted above a flag group. What does this mean?", a: ["communicatingusingtheinternationalcodeofsignals", "communicatingusingics"], display: "Communicating using the International Code of Signals" },
    { q: "You see a group of flags consisting of ‚ÄòNC‚Äô. What does this mean?", a: ["iamindistress", "distress"], display: "I am in distress" },
    { q: "How long should a tackline be?", a: ["2metres", "2meters", "2m"], display: "2 metres" },
    { q: "In general terms, how is a medical sign indicated by a flag group?", a: ["threelettersstartingwithm", "3lettersstartingwithm"], display: "Three letters starting with M" },
    { q: "What does the term ‚ÄòClose up‚Äô mean?", a: ["hoistedtothefullextentofthehalyards"], display: "Hoisted to the full extent of the halyards" },
    { q: "How is flag signalling concluded?", a: ["hoistthecodependantcloseup", "codependantcloseup"], display: "Hoist the Code Pendant close up" }
];

// --- UTILS ---
function normalize(str) { return str.toLowerCase().replace(/[^a-z0-9]/g, ""); }
function handleInputCase(e) { e.target.value = e.target.value.toUpperCase(); }
function levenshtein(a, b) { const matrix = []; for(let i=0; i<=b.length; i++) matrix[i] = [i]; for(let j=0; j<=a.length; j++) matrix[0][j] = j; for(let i=1; i<=b.length; i++) { for(let j=1; j<=a.length; j++) { if(b.charAt(i-1) == a.charAt(j-1)) matrix[i][j] = matrix[i-1][j-1]; else matrix[i][j] = Math.min(matrix[i-1][j-1]+1, matrix[i][j-1]+1, matrix[i-1][j]+1); } } return matrix[b.length][a.length]; }

// --- RENDER FLAG ---
function renderFlag(key) {
    const W = 300, H = 200;
    const C = { Y: "#facc15", B: "#2563eb", R: "#dc2626", W: "#f8fafc", K: "#1e293b" };
    const uid = key + "_" + Math.floor(Math.random() * 10000);
    let pathD = `M0,0 L300,0 L300,200 L0,200 Z`; 
    if (key === 'A' || key === 'B') pathD = `M0,0 L300,0 L220,100 L300,200 L0,200 Z`; 
    else if (DATA_NUMERALS[key] || key === 'ANS') pathD = `M0,0 L280,60 L280,140 L0,200 Z`; 
    else if (key && key.startsWith('SUB')) pathD = `M0,0 L260,100 L0,200 Z`; 
    const clipDef = `<defs><clipPath id="cp_${uid}"><path d="${pathD}"/></clipPath></defs>`;
    let content = "";
    const gClip = `<g clip-path="url(#cp_${uid})">`;
    const gEnd = `</g>`;
    switch(key) {
        case "A": content = gClip + `<rect x="0" y="0" width="120" height="200" fill="${C.W}"/><rect x="120" y="0" width="180" height="200" fill="${C.B}"/>` + gEnd; break;
        case "B": content = gClip + `<rect width="300" height="200" fill="${C.R}"/>` + gEnd; break;
        case "C": content = `<rect y="0" width="300" height="40" fill="${C.B}"/><rect y="40" width="300" height="40" fill="${C.W}"/><rect y="80" width="300" height="40" fill="${C.R}"/><rect y="120" width="300" height="40" fill="${C.W}"/><rect y="160" width="300" height="40" fill="${C.B}"/>`; break;
        case "D": content = `<rect y="0" width="300" height="50" fill="${C.Y}"/><rect y="50" width="300" height="100" fill="${C.B}"/><rect y="150" width="300" height="50" fill="${C.Y}"/>`; break;
        case "E": content = `<rect y="0" width="300" height="100" fill="${C.B}"/><rect y="100" width="300" height="100" fill="${C.R}"/>`; break;
        case "F": content = `<rect width="300" height="200" fill="${C.W}"/><path d="M150,20 L280,100 L150,180 L20,100 Z" fill="${C.R}"/>`; break;
        case "G": content = `<g>`; for(let i=0;i<6;i++) content+=`<rect x="${i*50}" width="50" height="200" fill="${i%2===0?C.Y:C.B}"/>`; content+=`</g>`; break;
        case "H": content = `<rect x="0" width="150" height="200" fill="${C.W}"/><rect x="150" width="150" height="200" fill="${C.R}"/>`; break;
        case "I": content = `<rect width="300" height="200" fill="${C.Y}"/><circle cx="150" cy="100" r="50" fill="${C.K}"/>`; break;
        case "J": content = `<rect y="0" width="300" height="66" fill="${C.B}"/><rect y="66" width="300" height="68" fill="${C.W}"/><rect y="134" width="300" height="66" fill="${C.B}"/>`; break;
        case "K": content = `<rect x="0" width="150" height="200" fill="${C.Y}"/><rect x="150" width="150" height="200" fill="${C.B}"/>`; break;
        case "L": content = `<rect x="0" y="0" width="150" height="100" fill="${C.Y}"/><rect x="150" y="0" width="150" height="100" fill="${C.K}"/><rect x="0" y="100" width="150" height="100" fill="${C.K}"/><rect x="150" y="100" width="150" height="100" fill="${C.Y}"/>`; break;
        case "M": content = `<rect width="300" height="200" fill="${C.B}"/><path d="M0,0 L20,0 L300,180 L300,200 L280,200 L0,20 Z" fill="${C.W}"/><path d="M300,0 L280,0 L0,180 L0,200 L20,200 L300,20 Z" fill="${C.W}"/>`; break;
        case "N": content = `<rect width="300" height="200" fill="${C.W}"/>`; for(let r=0;r<4;r++) for(let c=0;c<4;c++) if((r+c)%2===0) content+=`<rect x="${c*75}" y="${r*50}" width="75" height="50" fill="${C.B}"/>`; break;
        case "O": content = `<rect width="300" height="200" fill="${C.Y}"/><path d="M0,0 L300,0 L0,200 Z" fill="${C.R}"/>`; break;
        case "P": content = `<rect width="300" height="200" fill="${C.B}"/><rect x="100" y="66" width="100" height="68" fill="${C.W}"/>`; break;
        case "Q": content = `<rect width="300" height="200" fill="${C.Y}"/>`; break;
        case "R": content = `<rect width="300" height="200" fill="${C.R}"/><rect x="125" y="0" width="50" height="200" fill="${C.Y}"/><rect x="0" y="75" width="300" height="50" fill="${C.Y}"/>`; break;
        case "S": content = `<rect width="300" height="200" fill="${C.W}"/><rect x="100" y="66" width="100" height="68" fill="${C.B}"/>`; break;
        case "T": content = `<rect x="0" width="100" height="200" fill="${C.R}"/><rect x="100" width="100" height="200" fill="${C.W}"/><rect x="200" width="100" height="200" fill="${C.B}"/>`; break;
        case "U": content = `<rect x="0" y="0" width="150" height="100" fill="${C.R}"/><rect x="150" y="0" width="150" height="100" fill="${C.W}"/><rect x="0" y="100" width="150" height="100" fill="${C.W}"/><rect x="150" y="100" width="150" height="100" fill="${C.R}"/>`; break;
        case "V": content = `<rect width="300" height="200" fill="${C.W}"/><path d="M0,0 L20,0 L300,180 L300,200 L280,200 L0,20 Z" fill="${C.R}"/><path d="M300,0 L280,0 L0,180 L0,200 L20,200 L300,20 Z" fill="${C.R}"/>`; break;
        case "W": content = `<rect width="300" height="200" fill="${C.B}"/><rect x="50" y="33" width="200" height="134" fill="${C.W}"/><rect x="100" y="66" width="100" height="68" fill="${C.R}"/>`; break;
        case "X": content = `<rect width="300" height="200" fill="${C.W}"/><rect x="125" y="0" width="50" height="200" fill="${C.B}"/><rect x="0" y="75" width="300" height="50" fill="${C.B}"/>`; break;
        case "Y": content = `<rect width="300" height="200" fill="${C.Y}"/>`; for(let i=0;i<10;i++) content+=`<path d="M${i*60},0 L${(i*60)+30},0 L0,${(i*60)+30} L0,${i*60} Z" fill="${C.R}"/><path d="M300,${i*60} L300,${(i*60)+30} L${300-((i*60)+30)},0 L${300-(i*60)},0 Z" fill="${C.R}"/>`; break;
        case "Z": content = `<rect x="0" y="0" width="150" height="100" fill="${C.Y}"/><rect x="150" y="0" width="150" height="100" fill="${C.B}"/><rect x="0" y="100" width="150" height="100" fill="${C.R}"/><rect x="150" y="100" width="150" height="100" fill="${C.K}"/>`; break;
        case "1": content = gClip + `<rect width="300" height="200" fill="${C.W}"/><circle cx="100" cy="100" r="45" fill="${C.R}"/>` + gEnd; break;
        case "2": content = gClip + `<rect width="300" height="200" fill="${C.B}"/><circle cx="100" cy="100" r="45" fill="${C.W}"/>` + gEnd; break;
        case "3": content = gClip + `<rect x="0" width="100" height="200" fill="${C.R}"/><rect x="100" width="100" height="200" fill="${C.W}"/><rect x="200" width="100" height="200" fill="${C.B}"/>` + gEnd; break;
        case "4": content = gClip + `<rect width="300" height="200" fill="${C.R}"/><rect x="80" width="40" height="200" fill="${C.W}"/><rect y="80" width="300" height="40" fill="${C.W}"/>` + gEnd; break;
        case "5": content = gClip + `<rect x="0" width="100" height="200" fill="${C.Y}"/><rect x="100" width="200" height="200" fill="${C.B}"/>` + gEnd; break;
        case "6": content = gClip + `<rect y="0" width="300" height="100" fill="${C.K}"/><rect y="100" width="300" height="100" fill="${C.W}"/>` + gEnd; break;
        case "7": content = gClip + `<rect y="0" width="300" height="100" fill="${C.Y}"/><rect y="100" width="300" height="100" fill="${C.R}"/>` + gEnd; break;
        case "8": content = gClip + `<rect width="300" height="200" fill="${C.W}"/><rect x="80" width="40" height="200" fill="${C.R}"/><rect y="80" width="300" height="40" fill="${C.R}"/>` + gEnd; break;
        case "9": content = gClip + `<rect x="0" y="0" width="150" height="100" fill="${C.W}"/><rect x="150" y="0" width="150" height="100" fill="${C.K}"/><rect x="0" y="100" width="150" height="100" fill="${C.R}"/><rect x="150" y="100" width="150" height="100" fill="${C.Y}"/>` + gEnd; break;
        case "0": content = gClip + `<rect x="0" width="100" height="200" fill="${C.Y}"/><rect x="100" width="100" height="200" fill="${C.R}"/><rect x="200" width="100" height="200" fill="${C.Y}"/>` + gEnd; break;
        case "SUB1": content = gClip + `<rect width="300" height="200" fill="${C.B}"/><path d="M0,50 L140,100 L0,150 Z" fill="${C.Y}"/>` + gEnd; break;
        case "SUB2": content = gClip + `<rect x="0" width="150" height="200" fill="${C.B}"/><rect x="150" width="150" height="200" fill="${C.W}"/>` + gEnd; break;
        case "SUB3": content = gClip + `<rect width="300" height="200" fill="${C.W}"/><rect y="80" width="300" height="40" fill="${C.K}"/>` + gEnd; break;
        case "ANS": 
             content = gClip; for(let i=0; i<7; i++) content += `<rect x="${i*43}" width="43" height="200" fill="${i%2===0?C.R:C.W}"/>`; content += gEnd; break;
    }
    const stroke = `<path d="${pathD}" fill="none" stroke="#666" stroke-width="1"/>`;
    return `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${clipDef}${content}${stroke}</svg>`;
}

// ==========================================
//              FLAGS FUNCTIONS
// ==========================================
function goToFlagSetup() { hideAllScreens(); document.getElementById('screen-flags-setup').classList.remove('hidden'); }
function setFlagMode(m) { appState.flags.mode = m; updatePills('flag-mode-selector', m === 'CHAR' ? 0 : m === 'MEANING_MC' ? 1 : m === 'MEANING_TYPE' ? 2 : 3); const catGroup = document.getElementById('flag-cats-group'); if (m === 'SECONDARY') catGroup.classList.add('hidden'); else catGroup.classList.remove('hidden'); }
function toggleFlagCat(cat, el) { appState.flags.cats[cat] = !appState.flags.cats[cat]; if(!appState.flags.cats.letters && !appState.flags.cats.numerals && !appState.flags.cats.subs) appState.flags.cats[cat] = true; el.classList.toggle('active'); }
function toggleFlagAutoNext() { appState.flags.autoNext = !appState.flags.autoNext; const btn = document.getElementById('btn-flag-autonext'); btn.innerText = `Auto-Next: ${appState.flags.autoNext ? 'ON' : 'OFF'}`; btn.classList.toggle('active'); }
function setFlagCount(c) { appState.flags.count = c; const pills = document.getElementById('flag-count-selector').children; for(let p of pills) p.classList.remove('active'); event.target.classList.add('active'); }
function startFlagGame() {
    let pool = [];
    if (appState.flags.mode === 'SECONDARY') pool = DATA_SECONDARY.map(item => ({...item, type: 'secondary'}));
    else {
        if (appState.flags.cats.letters) pool.push(...Object.keys(DATA_LETTERS).map(k => ({id: k, ...DATA_LETTERS[k]})));
        if (appState.flags.cats.numerals) pool.push(...Object.keys(DATA_NUMERALS).map(k => ({id: k, ...DATA_NUMERALS[k]})));
        if (appState.flags.cats.subs) pool.push(...Object.keys(DATA_SUBS).map(k => ({id: k, ...DATA_SUBS[k]})));
    }
    pool.sort(() => Math.random() - 0.5);
    if(appState.flags.count !== 999) pool = pool.slice(0, appState.flags.count);
    appState.flags.qList = pool; appState.flags.currIdx = 0; appState.flags.score = 0; appState.flags.streak = 0; appState.flags.waiting = false; appState.flags.history = [];
    hideAllScreens(); document.getElementById('screen-flags-game').classList.remove('hidden'); loadFlagQ();
}
function loadFlagQ() {
    if(appState.flags.currIdx >= appState.flags.qList.length && appState.flags.count !== 999) { endGame('flags'); return; }
    appState.flags.waiting = false;
    const q = appState.flags.qList[appState.flags.currIdx % appState.flags.qList.length];
    document.getElementById('flag-hud-progress').innerText = `Question ${appState.flags.currIdx + 1} / ${appState.flags.count === 999 ? '‚àû' : appState.flags.count}`;
    document.getElementById('flag-val-streak').innerText = appState.flags.streak;
    document.getElementById('flag-val-acc').innerText = appState.flags.currIdx === 0 ? '100%' : Math.round((appState.flags.score / appState.flags.currIdx) * 100) + '%';
    if (appState.flags.streak >= 3) document.getElementById('flag-chip-streak').classList.add('hot'); else document.getElementById('flag-chip-streak').classList.remove('hot');
    const flagId = q.type === 'secondary' ? q.letter : q.id;
    document.getElementById('flag-stage').innerHTML = renderFlag(flagId) + `<div id="complement-badge" class="complement-text hidden"></div>`;
    const compBadge = document.getElementById('complement-badge');
    if (q.type === 'secondary') { compBadge.innerText = "+ " + q.complement; compBadge.classList.remove('hidden'); } else compBadge.classList.add('hidden');
    document.getElementById('flag-options-grid').classList.add('hidden');
    document.getElementById('flag-typing-area').classList.add('hidden');
    document.getElementById('flag-controls').classList.add('hidden');
    document.getElementById('flag-feedback-box').classList.add('hidden');
    const qText = document.getElementById('flag-q-text');
    if(appState.flags.mode === 'CHAR') { qText.innerText = "Identify this flag"; document.getElementById('flag-options-grid').classList.remove('hidden'); generateFlagOptions(q, 'labelShort'); }
    else if(appState.flags.mode === 'MEANING_MC') { qText.innerText = `What is the meaning of ${q.labelShort}?`; document.getElementById('flag-options-grid').classList.remove('hidden'); generateFlagOptions(q, 'primary'); }
    else if (appState.flags.mode === 'SECONDARY') { qText.innerText = `Meaning with complement: "${q.complement}"`; document.getElementById('flag-options-grid').classList.remove('hidden'); generateFlagOptions(q, 'meaning'); }
    else { qText.innerText = `Type meaning of ${q.labelShort}`; document.getElementById('flag-typing-area').classList.remove('hidden'); document.getElementById('flag-type-input').value = ""; document.getElementById('flag-type-input').focus(); }
}
function generateFlagOptions(correct, field) {
    const grid = document.getElementById('flag-options-grid'); grid.innerHTML = "";
    let pool = [];
    if (appState.flags.mode === 'SECONDARY') pool = DATA_SECONDARY.filter(x => x.id !== correct.id);
    else pool = Object.values(ALL_FLAGS).filter(x => x.labelLong !== correct.labelLong);
    pool.sort(() => Math.random() - 0.5);
    const opts = [correct, ...pool.slice(0, 3)].sort(() => Math.random() - 0.5);
    opts.forEach(opt => { const btn = document.createElement('div'); btn.className = 'option-btn'; btn.innerText = opt[field]; btn.onclick = () => checkFlagMC(opt, btn); grid.appendChild(btn); });
}
function checkFlagMC(selected, btn) {
    if (appState.flags.waiting) return;
    const correct = appState.flags.qList[appState.flags.currIdx % appState.flags.qList.length];
    let isCorrect = appState.flags.mode === 'SECONDARY' ? selected.id === correct.id : selected.labelLong === correct.labelLong;
    let realAnsText = appState.flags.mode === 'CHAR' ? correct.labelShort : (appState.flags.mode === 'SECONDARY' ? correct.meaning : correct.primary);
    let userAnsText = appState.flags.mode === 'CHAR' ? selected.labelShort : (appState.flags.mode === 'SECONDARY' ? selected.meaning : selected.primary);
    appState.flags.history.push({ q: correct, correct: isCorrect, userAns: userAnsText, realAns: realAnsText });
    if(isCorrect) { btn.classList.add('correct'); appState.flags.score++; appState.flags.streak++; if (appState.flags.autoNext) { appState.flags.waiting = true; setTimeout(nextFlagQ, 900); return; } }
    else { btn.classList.add('wrong'); appState.flags.streak = 0; Array.from(document.getElementById('flag-options-grid').children).forEach(child => { if(child.innerText === realAnsText) child.classList.add('correct'); }); }
    document.getElementById('flag-controls').classList.remove('hidden');
}
function submitFlagType() {
    if (appState.flags.waiting) return;
    const input = document.getElementById('flag-type-input').value.toLowerCase();
    const correct = appState.flags.qList[appState.flags.currIdx % appState.flags.qList.length];
    const keywords = correct.primary.toLowerCase().split(' ').filter(w => w.length > 3);
    const match = keywords.some(k => input.includes(k));
    const isCorrect = (match || input === correct.primary.toLowerCase());
    appState.flags.history.push({ q: correct, correct: isCorrect, userAns: input, realAns: correct.primary });
    const fb = document.getElementById('flag-feedback-box'); fb.classList.remove('hidden');
    if(isCorrect) { fb.innerHTML = "<span style='color:var(--success)'>Correct!</span>"; appState.flags.score++; appState.flags.streak++; if (appState.flags.autoNext) { appState.flags.waiting = true; setTimeout(nextFlagQ, 1000); return; } }
    else { fb.innerHTML = `<span style='color:var(--error)'>Incorrect.</span><br><small>${correct.primary}</small>`; appState.flags.streak = 0; }
    document.getElementById('flag-controls').classList.remove('hidden');
}
function nextFlagQ() { appState.flags.currIdx++; loadFlagQ(); }

// ==========================================
//              MORSE FUNCTIONS
// ==========================================
function goToMorseSetup() { hideAllScreens(); document.getElementById('screen-morse-setup').classList.remove('hidden'); }
function setMorseMode(m) { appState.morse.mode = m; updatePills('morse-mode-selector', m === 'tap' ? 0 : 1); }
function setMorseSet(s) { appState.morse.set = s; updatePills('morse-set-selector', s === 'limited' ? 0 : s === 'nums' ? 1 : 2); }
function toggleMorseAutoNext() { appState.morse.autoNext = !appState.morse.autoNext; const btn = document.getElementById('btn-morse-autonext'); btn.innerText = `Auto-Next: ${appState.morse.autoNext ? 'ON' : 'OFF'}`; btn.classList.toggle('active'); }
function toggleMorseSound() { appState.morse.soundEnabled = !appState.morse.soundEnabled; const btn = document.getElementById('btn-morse-sound'); btn.innerText = `Sound: ${appState.morse.soundEnabled ? 'ON' : 'OFF'}`; btn.classList.toggle('active'); }
function startMorseGame() {
    let pool = []; if(appState.morse.set === 'limited') pool = LIMITED_LETTERS; else if(appState.morse.set === 'nums') pool = NUMBERS_ARR; else pool = [...ALL_LETTERS_ARR, ...NUMBERS_ARR];
    appState.morse.pool = pool; appState.morse.streak = 0; appState.morse.ditEma = null; appState.morse.waiting = false; appState.morse.history = []; appState.morse.correctCount = 0; appState.morse.wrongCount = 0;
    hideAllScreens(); document.getElementById('screen-morse-game').classList.remove('hidden');
    document.getElementById('morse-mode-label').innerText = appState.morse.mode === 'tap' ? 'TAP MODE' : 'SEND MODE';
    document.getElementById('morse-tap-controls').classList.toggle('hidden', appState.morse.mode !== 'tap');
    document.getElementById('morse-send-controls').classList.toggle('hidden', appState.morse.mode !== 'send');
    document.getElementById('morse-chip-wpm').classList.toggle('hidden', appState.morse.mode !== 'send');
    pickMorseChar();
}
function pickMorseChar() {
    const char = appState.morse.pool[Math.floor(Math.random() * appState.morse.pool.length)];
    appState.morse.target = char; appState.morse.typed = ""; appState.morse.waiting = false;
    document.getElementById('morse-target-char').innerText = char; document.getElementById('morse-user-input').innerText = ""; document.getElementById('morse-feedback').innerText = ""; document.getElementById('morse-val-streak').innerText = appState.morse.streak;
    const checkBtn = document.getElementById('btn-morse-check'); checkBtn.innerText = "Check"; checkBtn.classList.remove('btn-success');
    if(appState.morse.streak >= 3) document.getElementById('morse-chip-streak').classList.add('hot'); else document.getElementById('morse-chip-streak').classList.remove('hot');
}
function morseInput(symbol) { if (appState.morse.waiting) return; appState.morse.typed += symbol; document.getElementById('morse-user-input').innerText = appState.morse.typed; }
function tapDot(e) { if(e && e.preventDefault) e.preventDefault(); playBeep(60); morseInput('.'); }
function tapDash(e) { if(e && e.preventDefault) e.preventDefault(); playBeep(180); morseInput('-'); }
function morseBackspace() { if (appState.morse.waiting) return; appState.morse.typed = appState.morse.typed.slice(0, -1); document.getElementById('morse-user-input').innerText = appState.morse.typed; }
function morseClear() { if (appState.morse.waiting) return; appState.morse.typed = ""; document.getElementById('morse-user-input').innerText = ""; }
function checkMorse() {
    if (appState.morse.waiting) { pickMorseChar(); return; }
    const correctCode = MORSE_MAP[appState.morse.target]; const userCode = appState.morse.typed; const feedback = document.getElementById('morse-feedback'); const isCorrect = (userCode === correctCode); const checkBtn = document.getElementById('btn-morse-check');
    appState.morse.history.push({ target: appState.morse.target, correctCode: correctCode, userCode: userCode, correct: isCorrect });
    if (isCorrect) { feedback.innerHTML = "<span style='color:var(--success)'>Correct!</span>"; appState.morse.streak++; appState.morse.correctCount++; appState.morse.waiting = true; if (appState.morse.autoNext) setTimeout(pickMorseChar, 1000); else { checkBtn.innerText = "Next ‚û°"; checkBtn.classList.add('btn-success'); } }
    else { feedback.innerHTML = `<span style='color:var(--error)'>Wrong!</span> ${correctCode}`; appState.morse.streak = 0; appState.morse.wrongCount++; appState.morse.typed = ""; document.getElementById('morse-user-input').innerText = ""; document.getElementById('morse-val-streak').innerText = 0; document.getElementById('morse-chip-streak').classList.remove('hot'); }
}
const DASH_THRESHOLD_MS = 250; const EMA_ALPHA = 0.2; let pressAnim = null; const keyerBtn = document.getElementById('keyer-btn'); const pressBar = document.getElementById('press-bar');
function pressDown(e) { if(appState.morse.mode !== 'send' || appState.morse.waiting) return; e.preventDefault(); if(appState.morse.pressActive) return; appState.morse.pressActive = true; appState.morse.pressStart = performance.now(); keyerBtn.classList.add('pressed'); playTone(); const start = performance.now(); const tick = () => { if(!appState.morse.pressActive) return; const elapsed = performance.now() - start; const pct = Math.min((elapsed / DASH_THRESHOLD_MS) * 100, 100); pressBar.style.width = pct + "%"; pressAnim = requestAnimationFrame(tick); }; pressAnim = requestAnimationFrame(tick); }
function pressUp(e) {
    if(appState.morse.mode !== 'send' || appState.morse.waiting) return; e.preventDefault(); if(!appState.morse.pressActive) return; stopTone(); appState.morse.pressActive = false; keyerBtn.classList.remove('pressed'); if(pressAnim) cancelAnimationFrame(pressAnim); pressBar.style.width = "0%";
    const dur = performance.now() - appState.morse.pressStart; const sym = (dur >= DASH_THRESHOLD_MS) ? "-" : "."; morseInput(sym);
    const ditGuess = (sym === ".") ? dur : (dur / 3); const old = appState.morse.ditEma; appState.morse.ditEma = (old == null) ? ditGuess : (EMA_ALPHA * ditGuess + (1 - EMA_ALPHA) * old);
    const wpm = Math.round(1200 / appState.morse.ditEma); if(isFinite(wpm) && wpm > 0 && wpm < 60) document.getElementById('morse-val-wpm').innerText = wpm + " WPM";
}
keyerBtn.addEventListener('mousedown', pressDown); keyerBtn.addEventListener('touchstart', pressDown); document.addEventListener('mouseup', pressUp); document.addEventListener('touchend', pressUp);

// ==========================================
//              PROSIGNS LOGIC
// ==========================================
function goToProsigns() { hideAllScreens(); document.getElementById('screen-prosigns').classList.remove('hidden'); const tbody = document.getElementById('prosigns-tbody'); tbody.innerHTML = ""; PROSIGNS.forEach(item => { const tr = document.createElement('tr'); tr.className = "row-item"; let displayCode = item.code; if(item.bar) displayCode = `<span class="overbar">${item.code}</span>`; tr.innerHTML = `<td>${displayCode}</td><td>${item.meaning}</td>`; tbody.appendChild(tr); }); }
function startProsignsGame() { appState.prosigns.qList = [...PROSIGNS].sort(() => Math.random() - 0.5); appState.prosigns.currIdx = 0; appState.prosigns.score = 0; appState.prosigns.streak = 0; appState.prosigns.waiting = false; appState.prosigns.history = []; hideAllScreens(); document.getElementById('screen-prosigns-game').classList.remove('hidden'); loadProsignQ(); }
function loadProsignQ() {
    if(appState.prosigns.currIdx >= 10 || appState.prosigns.currIdx >= appState.prosigns.qList.length) { endGame('prosigns'); return; }
    appState.prosigns.waiting = false; const q = appState.prosigns.qList[appState.prosigns.currIdx];
    document.getElementById('pro-hud-progress').innerText = `${appState.prosigns.currIdx + 1}/10`; document.getElementById('pro-val-streak').innerText = appState.prosigns.streak;
    if (appState.prosigns.streak >= 3) document.getElementById('pro-chip-streak').classList.add('hot'); else document.getElementById('pro-chip-streak').classList.remove('hot');
    const displayEl = document.getElementById('prosign-display'); displayEl.innerText = q.code; if (q.bar) displayEl.classList.add('overbar'); else displayEl.classList.remove('overbar');
    document.getElementById('pro-controls').classList.add('hidden');
    const grid = document.getElementById('pro-options-grid'); grid.innerHTML = "";
    const distractors = PROSIGNS.filter(x => x.code !== q.code).sort(() => Math.random() - 0.5).slice(0, 3); const opts = [q, ...distractors].sort(() => Math.random() - 0.5);
    opts.forEach(opt => { const btn = document.createElement('div'); btn.className = 'option-btn'; btn.innerText = opt.meaning; btn.onclick = () => checkProsign(opt, btn); grid.appendChild(btn); });
}
function checkProsign(selected, btn) {
    if(appState.prosigns.waiting) return; const correct = appState.prosigns.qList[appState.prosigns.currIdx]; const isCorrect = (selected.code === correct.code);
    appState.prosigns.history.push({ q: correct, correct: isCorrect, userAns: selected.meaning, realAns: correct.meaning });
    if(isCorrect) { btn.classList.add('correct'); appState.prosigns.score++; appState.prosigns.streak++; appState.prosigns.waiting = true; setTimeout(nextProsignQ, 1000); }
    else { btn.classList.add('wrong'); appState.prosigns.streak = 0; Array.from(document.getElementById('pro-options-grid').children).forEach(child => { if(child.innerText === correct.meaning) child.classList.add('correct'); }); document.getElementById('pro-controls').classList.remove('hidden'); }
}
function nextProsignQ() { appState.prosigns.currIdx++; loadProsignQ(); }

// ==========================================
//              EXAM LOGIC (MERGED)
// ==========================================
function goToExam() { hideAllScreens(); document.getElementById('screen-exam').classList.remove('hidden'); initExam(); }
function initExam() { loadExamSection(1); }
function loadExamSection(n) {
    appState.exam.section = n; appState.exam.skipped = false; updateExamProgress();
    if(n > 4) document.querySelector('.skip-btn-container').classList.add('hidden');
    const content = document.getElementById('exam-content'); content.innerHTML = ''; 
    if (n === 1) setupSection1(content); else if (n === 2) setupSection2(content); else if (n === 3) setupSection3(content); else if (n === 4) setupSection4(content); else showExamFinalResults(content);
}
function updateExamProgress() { const pct = ((appState.exam.section - 1) / 4) * 100; document.getElementById('exam-main-progress').style.width = pct + "%"; document.getElementById('exam-status').innerText = appState.exam.section <= 4 ? `Section ${appState.exam.section} of 4` : "Exam Complete"; }
function skipExamSection() { appState.exam.scores[appState.exam.section] = 0; appState.exam.skipped = true; nextExamSection(appState.exam.section); }
function nextExamSection(current) { loadExamSection(current + 1); }

// EXAM S1: VISUAL MORSE
function setupSection1(container) {
    const sequence = []; const ALL_CHARS_EXAM = [...Object.keys(DATA_LETTERS), ...NUMBERS_ARR];
    for(let i=0; i<20; i++) sequence.push(ALL_CHARS_EXAM[Math.floor(Math.random()*ALL_CHARS_EXAM.length)]);
    appState.exam.sectionData.sequence = sequence;
    container.innerHTML = `<div class="exam-section-title">Section 1: Visual Morse Reception (20 Marks)</div><div class="signal-light" id="signal-light"></div><p style="text-align:center; margin-bottom:20px;">Watch the light. 20 Characters. 4s Gap.</p><div style="text-align:center;"><button class="btn" id="btn-start-flash" onclick="startFlashSequence()">Start Sequence</button></div><div id="sec1-input-area" class="hidden" style="margin-top:20px;"><label>Type chars as they appear:</label><input type="text" id="input-sec1" placeholder="Type letters..." autocomplete="off" oninput="handleInputCase(event)"><div style="text-align:center; margin-top:15px;"><button class="btn btn-success" onclick="gradeSection1()">Submit Section 1</button></div></div><div id="sec1-feedback" class="feedback-box hidden"></div>`;
}
function startFlashSequence() {
    const btn = document.getElementById('btn-start-flash'); btn.disabled = true; const light = document.getElementById('signal-light'); const seq = appState.exam.sectionData.sequence;
    const inputArea = document.getElementById('sec1-input-area'); const inputField = document.getElementById('input-sec1');
    inputArea.classList.remove('hidden'); inputField.value = ""; inputField.focus();
    
    // UPDATED TIMING (A bit shorter dot)
    const DOT = 600; // Was 800
    const DASH = 2000;
    const INTRA_GAP = 600; // Keep rhythm consistent
    const INTER_GAP = 4000; 
    let timeline = [], currentTime = 500;
    
    timeline.push({ time: currentTime, on: true }); currentTime += 3000; timeline.push({ time: currentTime, on: false }); currentTime += 2000; 
    seq.forEach(char => { const code = MORSE_MAP[char]; code.split('').forEach((symbol, idx) => { const duration = symbol === '.' ? DOT : DASH; timeline.push({ time: currentTime, on: true }); currentTime += duration; timeline.push({ time: currentTime, on: false }); if (idx < code.length - 1) currentTime += INTRA_GAP; }); currentTime += INTER_GAP; });
    timeline.forEach(event => { setTimeout(() => { if(event.on) light.classList.add('lit'); else light.classList.remove('lit'); }, event.time); });
}
function gradeSection1() {
    const userAns = document.getElementById('input-sec1').value.toUpperCase().replace(/\s/g, '').split(''); const realAns = appState.exam.sectionData.sequence; let correct = 0;
    let compHTML = `<div class="comparison-container"><div class="label-row">Input:</div><div class="comp-row">`;
    for(let i=0; i<Math.max(realAns.length, userAns.length); i++) { const u = userAns[i]||'', r = realAns[i]||''; let cls='char-miss'; if(u===r && u!==''){ cls='char-correct'; correct++; } else if(u!=='') cls='char-wrong'; compHTML += `<div class="char-box ${cls}">${u||'?'}</div>`; }
    compHTML += `</div><div class="label-row" style="margin-top:10px;">Correct:</div><div class="comp-row">`; realAns.forEach(c => compHTML += `<div class="char-box">${c}</div>`); compHTML += `</div></div>`;
    appState.exam.scores[1] = correct; showExamFeedback(1, correct >= 18, correct, 20, compHTML, true);
}

// EXAM S2: THEORY
function setupSection2(container) {
    const shuffled = [...THEORY_POOL].sort(() => 0.5 - Math.random());
    const selectedQs = [];
    let distressCount = 0;
    
    // DISTRESS LIMITER LOGIC
    for(let q of shuffled) {
        if(selectedQs.length >= 10) break;
        const isDistress = q.a.some(ans => ans.includes('distress'));
        if(isDistress) {
            if(distressCount < 1) { selectedQs.push(q); distressCount++; }
        } else {
            selectedQs.push(q);
        }
    }
    
    appState.exam.sectionData.theoryQs = selectedQs;
    let html = `<div class="exam-section-title">Section 2: Written Theory (10 Marks)</div><div style="text-align:left;">`;
    selectedQs.forEach((q, idx) => { html += `<div class="theory-q" id="wrapper-q2-${idx}"><label>${idx+1}. ${q.q}</label><div class="input-wrapper"><input type="text" id="q2-${idx}" placeholder="Answer..."><div id="icon-q2-${idx}" class="status-icon"></div></div><div id="feedback-q2-${idx}" class="feedback-msg hidden"></div></div>`; });
    html += `</div><div style="text-align:center;"><button class="btn btn-success" onclick="gradeSection2()">Submit Section 2</button></div><div id="sec2-feedback" class="feedback-box hidden"></div>`;
    container.innerHTML = html;
}
function gradeSection2() {
    let correct = 0;
    appState.exam.sectionData.theoryQs.forEach((q, idx) => {
        const input = document.getElementById(`q2-${idx}`); const icon = document.getElementById(`icon-q2-${idx}`); const feedback = document.getElementById(`feedback-q2-${idx}`);
        input.disabled = true; const normVal = normalize(input.value); const hit = q.a.some(ans => normVal.includes(ans));
        if(hit) { correct++; input.classList.add('border-correct'); icon.innerHTML = "‚úÖ"; } else { input.classList.add('border-wrong'); icon.innerHTML = "‚ùå"; feedback.innerHTML = `Correct Answer: ${q.display}`; feedback.classList.remove('hidden'); }
    });
    appState.exam.scores[2] = correct; showExamFeedback(2, correct >= 9, correct, 10, "", false);
}

// EXAM S3: FLAGS
function setupSection3(container) {
    const pool = Object.keys(DATA_LETTERS); const questions = []; for(let i=0; i<10; i++) questions.push(pool[Math.floor(Math.random() * pool.length)]); appState.exam.sectionData.flags = questions;
    let html = `<div class="exam-section-title">Section 3: Flag Meanings (10 Marks)</div>`;
    questions.forEach((flag, idx) => { html += `<div class="theory-q" style="text-align:center;" id="wrapper-q3-${idx}"><div class="flag-stage">${renderFlag(flag)}</div><label style="text-align:left;">Meaning of Flag ${flag}:</label><div class="input-wrapper"><input type="text" id="q3-${idx}" placeholder="Meaning..."><div id="icon-q3-${idx}" class="status-icon"></div></div><div id="feedback-q3-${idx}" class="feedback-msg hidden" style="text-align:left;"></div></div>`; });
    html += `<div style="text-align:center;"><button class="btn btn-success" onclick="gradeSection3()">Submit Section 3</button></div><div id="sec3-feedback" class="feedback-box hidden"></div>`;
    container.innerHTML = html;
}
function gradeSection3() {
    let correct = 0;
    appState.exam.sectionData.flags.forEach((flag, idx) => {
        const input = document.getElementById(`q3-${idx}`); const icon = document.getElementById(`icon-q3-${idx}`); const feedback = document.getElementById(`feedback-q3-${idx}`);
        input.disabled = true; const normVal = normalize(input.value); const realStr = DATA_LETTERS[flag].primary; const normReal = normalize(realStr); let hit = false;
        if (flag === 'C') { if (normVal.includes('yes') || normVal.includes('affirmative')) hit = true; } else if (flag === 'N') { if (normVal.includes('no') || normVal.includes('negative')) hit = true; } else { const keywords = realStr.toLowerCase().split(/[^a-z]+/).filter(w => w.length > 3); if (normVal === normReal) hit = true; else if (keywords.length > 0 && keywords.some(k => normVal.includes(k))) hit = true; }
        if(hit) { correct++; input.classList.add('border-correct'); icon.innerHTML = "‚úÖ"; } else { input.classList.add('border-wrong'); icon.innerHTML = "‚ùå"; feedback.innerHTML = `Correct Answer: ${realStr}`; feedback.classList.remove('hidden'); }
    });
    appState.exam.scores[3] = correct; showExamFeedback(3, correct >= 9, correct, 10, "", false);
}

// EXAM S4: MORSE TX
function setupSection4(container) {
    const chars = []; const ALL_CHARS_EXAM = [...Object.keys(DATA_LETTERS), ...NUMBERS_ARR];
    for(let i=0; i<10; i++) chars.push(ALL_CHARS_EXAM[Math.floor(Math.random()*ALL_CHARS_EXAM.length)]);
    const targetString = chars.join(''); appState.exam.sectionData.sendTarget = targetString; appState.exam.sectionData.sendInputDecoded = ""; appState.exam.sectionData.sendCurrentBuffer = "";
    container.innerHTML = `<div class="exam-section-title">Section 4: Morse Sending (10 Marks)</div><p style="text-align:center; font-size:1.2rem; margin-bottom:20px;">Send this sequence:</p><div style="background:rgba(255,255,255,0.1); padding:15px; border-radius:8px; text-align:center; font-family:monospace; font-size:2rem; letter-spacing:5px; margin-bottom:20px;">${targetString}</div><div id="exam-keyer-btn" class="keyer-btn-base">TAP KEY</div><div style="text-align:center; margin-top:20px; color:var(--text-muted);">Decoded Output:</div><div id="send-display" class="send-display-box"></div><div class="live-dots" id="live-dots"></div><div style="text-align:center; margin-top:30px;"><button class="btn" onclick="clearExamSend()">Clear All</button><button class="btn btn-success" onclick="gradeSection4()">Submit Section 4</button></div><div id="sec4-feedback" class="feedback-box hidden"></div>`;
    setupExamKeyer();
}
let examPressStart=0; let examSegTimer=null;
function setupExamKeyer() {
    const btn = document.getElementById('exam-keyer-btn'); if(!btn) return;
    const handleDown = (e) => { e.preventDefault(); clearTimeout(examSegTimer); btn.classList.add('pressed'); examPressStart = performance.now(); playTone(); };
    const handleUp = (e) => {
        e.preventDefault(); btn.classList.remove('pressed'); stopTone();
        const dur = performance.now() - examPressStart;
        const sym = dur > 250 ? '-' : '.';
        processExamInputSymbol(sym);
        examSegTimer = setTimeout(() => { finishExamCharacter(); }, 1500);
    };
    btn.addEventListener('mousedown', handleDown);
    btn.addEventListener('touchstart', handleDown);
    btn.addEventListener('mouseup', handleUp);
    btn.addEventListener('touchend', handleUp);
}
function processExamInputSymbol(sym) { appState.exam.sectionData.sendCurrentBuffer += sym; document.getElementById('live-dots').innerText = appState.exam.sectionData.sendCurrentBuffer; if (appState.exam.sectionData.sendCurrentBuffer.endsWith(".......")) triggerExamErrorSignal(); }
function triggerExamErrorSignal() { clearTimeout(examSegTimer); appState.exam.sectionData.sendCurrentBuffer = ""; document.getElementById('live-dots').innerText = ""; let cur = appState.exam.sectionData.sendInputDecoded; if (cur.length > 0) appState.exam.sectionData.sendInputDecoded = cur.slice(0, -1); updateExamDecodedDisplay(); const box = document.getElementById('send-display'); box.classList.add('flash-red'); setTimeout(() => box.classList.remove('flash-red'), 300); }
function finishExamCharacter() { const code = appState.exam.sectionData.sendCurrentBuffer; if (!code) return; const REVERSE_MORSE = Object.fromEntries(Object.entries(MORSE_MAP).map(a => a.reverse())); const char = REVERSE_MORSE[code]; if (char) appState.exam.sectionData.sendInputDecoded += char; else appState.exam.sectionData.sendInputDecoded += "?"; appState.exam.sectionData.sendCurrentBuffer = ""; document.getElementById('live-dots').innerText = ""; updateExamDecodedDisplay(); }
function updateExamDecodedDisplay() { document.getElementById('send-display').innerText = appState.exam.sectionData.sendInputDecoded; }
function clearExamSend() { appState.exam.sectionData.sendInputDecoded = ""; appState.exam.sectionData.sendCurrentBuffer = ""; document.getElementById('live-dots').innerText = ""; updateExamDecodedDisplay(); }
function gradeSection4() {
    let targetCode = ""; appState.exam.sectionData.sendTarget.split('').forEach(c => targetCode += MORSE_MAP[c]);
    const input = appState.exam.sectionData.sendInputDecoded.replace(/ /g, ''); const target = appState.exam.sectionData.sendTarget;
    let correct = 0;
    let compHTML = `<div class="comparison-container"><div class="label-row">You Sent:</div><div class="comp-row">`;
    for(let i=0; i<Math.max(target.length, input.length); i++) {
        const u = input[i] || '', r = target[i] || '';
        let cls = 'char-miss';
        if (u === r && u !== '') { cls = 'char-correct'; correct++; } else if (u !== '') { cls = 'char-wrong'; }
        compHTML += `<div class="char-box ${cls}">${u || '?'}</div>`;
    }
    compHTML += `</div><div class="label-row" style="margin-top:10px;">Target:</div><div class="comp-row">`; target.split('').forEach(c => { compHTML += `<div class="char-box">${c}</div>`; });
    compHTML += `</div></div>`;
    appState.exam.scores[4] = correct; showExamFeedback(4, correct >= 9, correct, 10, compHTML, true);
}

// EXAM COMMON
function showExamFeedback(secNum, passed, score, total, htmlContent, isHTML = false) {
    const box = document.getElementById(`sec${secNum}-feedback`); box.classList.remove('hidden'); const msg = passed ? `<div class="pass-text">PASSED (${score}/${total})</div>` : `<div class="fail-text">FAILED (${score}/${total})</div>`; let content = msg; if (htmlContent) content += (isHTML ? htmlContent : `<div>Correct Answer: ${htmlContent}</div>`);
    if(passed) content += `<div style="margin-top:15px;"><button class="btn" onclick="nextExamSection(${secNum})">Next Section</button></div>`; else content += `<div style="margin-top:15px;"><button class="btn btn-danger" onclick="loadExamSection(${secNum})">Retry Section</button></div>`; box.innerHTML = content;
}
function showExamFinalResults(container) {
    const s = appState.exam.scores; const total = s[1] + s[2] + s[3] + s[4]; const pct = Math.round((total / 50) * 100);
    container.innerHTML = `<div style="text-align:center; padding:40px;"><div style="font-size:4rem; margin-bottom:10px;">üèÜ</div><h2 style="color:var(--accent);">EXAM RESULTS</h2><div style="background:rgba(255,255,255,0.05); border-radius:12px; padding:20px; margin:30px 0;"><div style="font-size:3rem; font-weight:800; color:${pct>=90?'var(--success)':'var(--gold)'};">${pct}%</div><div style="color:var(--text-muted);">Total Score: ${total} / 50</div></div><div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; text-align:left; font-size:0.9rem; color:var(--text-muted);"><div>Morse Rx: ${s[1]}/20</div><div>Theory: ${s[2]}/10</div><div>Flags: ${s[3]}/10</div><div>Morse Tx: ${s[4]}/10</div></div><button class="btn" style="margin-top:30px;" onclick="initExam()">Take Exam Again</button></div>`;
}

// --- RESULTS (GENERAL) ---
function endGame(mode) {
    hideAllScreens(); document.getElementById('screen-results').classList.remove('hidden');
    let total = 0, correct = 0, history = [];
    if (mode === 'flags') history = appState.flags.history; else if (mode === 'morse') history = appState.morse.history; else history = appState.prosigns.history;
    total = history.length; correct = history.filter(h => h.correct).length; const p = total === 0 ? 0 : Math.round((correct / total) * 100);
    document.getElementById('final-score-percent').innerText = `${p}%`; document.getElementById('final-score-text').innerText = `${correct} out of ${total} correct`;
    const list = document.getElementById('review-list'); list.innerHTML = "";
    history.forEach(item => {
        const div = document.createElement('div'); div.className = `result-item ${item.correct ? 'r-correct' : 'r-wrong'}`;
        if (mode === 'flags') { const flagKey = item.q.type === 'secondary' ? item.q.letter : item.q.id; div.innerHTML = `<div class="result-mini-flag">${renderFlag(flagKey)}</div><div class="result-info"><div>${item.q.labelShort || item.q.letter}</div>${!item.correct ? `<div class="user-ans">You: ${item.userAns}</div>` : ''}<div class="real-ans">${item.realAns}</div></div>`; }
        else if (mode === 'morse') { div.innerHTML = `<div class="result-mini-morse">${item.target}</div><div class="result-info"><div style="letter-spacing:2px; font-weight:bold;">${item.correctCode}</div>${!item.correct ? `<div class="user-ans">You: ${item.userCode || '(empty)'}</div>` : ''}</div>`; }
        else { const codeDisplay = item.q.bar ? `<span class="overbar">${item.q.code}</span>` : item.q.code; div.innerHTML = `<div class="result-mini-prosign">${codeDisplay}</div><div class="result-info"><div style="font-weight:bold;">${item.q.meaning}</div>${!item.correct ? `<div class="user-ans">You: ${item.userAns}</div>` : ''}</div>`; }
        list.appendChild(div);
    });
}

function updatePills(parentId, activeIdx) { const p = document.getElementById(parentId).children; for(let i=0; i<p.length; i++) p[i].classList.remove('active'); p[activeIdx].classList.add('active'); }

</script>
</body>
</html>