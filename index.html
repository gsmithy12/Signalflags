<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Maritime Signals Mastery</title>
<style>
/* --- CSS VARIABLES & RESET --- */
:root {
    --text-main: #ffffff;
    --text-muted: #cbd5e1;
    --accent: #0ea5e9;       /* Sky Blue */
    --accent-glow: rgba(14, 165, 233, 0.4);
    --success: #4ade80;      /* Green */
    --error: #f87171;        /* Red */
    --gold: #facc15;         /* Gold */
    --glass-bg: rgba(30, 41, 59, 0.85);
    --glass-border: rgba(255, 255, 255, 0.1);
    --glass-blur: 24px;
    --radius: 16px;
}

* { box-sizing: border-box; margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }

/* --- ANIMATED BACKGROUND --- */
body {
    background-color: #0f172a;
    background-image: 
        radial-gradient(at 0% 0%, hsla(253,16%,7%,1) 0, transparent 50%), 
        radial-gradient(at 50% 0%, hsla(225,39%,30%,1) 0, transparent 50%), 
        radial-gradient(at 100% 0%, hsla(339,49%,30%,1) 0, transparent 50%);
    background-attachment: fixed;
    background-size: cover;
    color: var(--text-main);
    min-height: 100vh;
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: 20px;
    overflow-x: hidden;
    user-select: none;
    -webkit-user-select: none;
}

/* --- LAYOUT UTILS --- */
.container { width: 100%; max-width: 800px; margin: 0 auto; position: relative; z-index: 1; }
.hidden { display: none !important; }

h1 { 
    font-size: 2.2rem; 
    font-weight: 800;
    text-align: center; 
    margin-bottom: 0.5rem;
    background: linear-gradient(to right, #38bdf8, #818cf8);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-transform: uppercase; 
    letter-spacing: 2px; 
    text-shadow: 0 4px 12px rgba(0,0,0,0.3);
}

h3 { margin-bottom: 1rem; text-align: center; }

/* --- GLASS CARDS --- */
.card {
    background: var(--glass-bg);
    backdrop-filter: blur(var(--glass-blur));
    -webkit-backdrop-filter: blur(var(--glass-blur));
    border: 1px solid var(--glass-border);
    border-radius: var(--radius);
    padding: 2rem;
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
    margin-bottom: 1.5rem;
    transition: transform 0.3s ease;
}

/* --- HOME SCREEN --- */
.mode-select-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    margin-top: 30px;
}
/* Full width for single items on last row if needed, or 3 items */
.mode-select-grid.three-items {
    grid-template-columns: 1fr 1fr; 
}
.big-mode-btn {
    background: linear-gradient(145deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.02) 100%);
    border: 1px solid rgba(255,255,255,0.1);
    border-radius: var(--radius);
    padding: 30px;
    text-align: center;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}
.big-mode-btn:hover {
    transform: translateY(-5px);
    background: linear-gradient(145deg, rgba(255,255,255,0.15) 0%, rgba(255,255,255,0.05) 100%);
    border-color: var(--accent);
    box-shadow: 0 10px 30px rgba(14, 165, 233, 0.2);
}
/* Span full width for Prosigns if desired, or keep grid */
.big-mode-btn.full-width {
    grid-column: span 2;
}

.big-mode-icon { font-size: 3rem; margin-bottom: 10px; }
.big-mode-title { font-size: 1.5rem; font-weight: 800; color: var(--accent); }
.big-mode-desc { color: var(--text-muted); font-size: 0.9rem; }

.footer-credit {
    margin-top: 30px;
    text-align: center;
    font-size: 0.8rem;
    color: var(--text-muted);
    letter-spacing: 1px;
    opacity: 0.7;
    text-transform: uppercase;
    font-weight: bold;
}

/* --- HUD DASHBOARD --- */
.hud-dashboard {
    display: flex;
    flex-direction: column;
    gap: 15px;
    margin-bottom: 20px;
    background: rgba(15, 23, 42, 0.6);
    backdrop-filter: blur(10px);
    padding: 15px 20px;
    border-radius: var(--radius);
    border: 1px solid var(--glass-border);
    box-shadow: 0 4px 20px rgba(0,0,0,0.2);
}
.hud-top-row {
    display: flex; justify-content: space-between; align-items: center;
    font-size: 0.9rem; color: var(--text-muted);
    border-bottom: 1px solid rgba(255,255,255,0.05); padding-bottom: 10px;
    text-transform: uppercase; letter-spacing: 1px;
}
.hud-stats-row {
    display: flex; flex-wrap: wrap; gap: 12px; justify-content: center;
}
.stat-chip {
    display: flex; align-items: center; gap: 8px; padding: 8px 16px;
    border-radius: 50px; background: rgba(255,255,255,0.03);
    border: 1px solid rgba(255,255,255,0.05);
    font-size: 0.95rem; font-weight: 600;
}
.chip-streak.hot { 
    color: #fff; background: linear-gradient(135deg, rgba(251, 191, 36, 0.2), rgba(245, 158, 11, 0.4)); 
    border-color: rgba(251, 191, 36, 0.5); 
    box-shadow: 0 0 15px rgba(251, 191, 36, 0.2);
    animation: pulse-gold 2s infinite;
}
@keyframes pulse-gold { 0% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0.4); } 70% { box-shadow: 0 0 0 10px rgba(251, 191, 36, 0); } 100% { box-shadow: 0 0 0 0 rgba(251, 191, 36, 0); } }
.chip-acc { color: var(--accent); }
.chip-wpm { color: var(--gold); border-color: rgba(251, 191, 36, 0.3); }

/* --- FLAG STAGE --- */
.flag-stage {
    display: flex; justify-content: center; align-items: center;
    margin: 1rem 0 2rem 0; min-height: 240px;
    background: radial-gradient(circle at center, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.95));
    border-radius: var(--radius); padding: 20px; position: relative;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
}
.flag-stage svg { height: 180px; width: auto; filter: drop-shadow(0 10px 20px rgba(0,0,0,0.5)); }
.complement-text {
    position: absolute; bottom: 15px; right: 15px;
    background: rgba(0,0,0,0.8); padding: 6px 12px; border-radius: 8px;
    font-size: 0.9rem; font-weight: bold; color: var(--gold); border: 1px solid rgba(255,255,255,0.1);
}

/* --- MORSE STAGE --- */
.morse-stage {
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    margin: 1rem 0 2rem 0; min-height: 240px;
    background: radial-gradient(circle at center, rgba(30, 41, 59, 0.8), rgba(15, 23, 42, 0.95));
    border-radius: var(--radius); padding: 20px;
    box-shadow: inset 0 0 20px rgba(0,0,0,0.5); border: 1px solid rgba(255,255,255,0.05);
}
.morse-big-char { font-size: 6rem; font-weight: 900; color: var(--text-main); text-shadow: 0 5px 15px rgba(0,0,0,0.5); margin-bottom: 10px; }
.morse-display-code { 
    font-family: monospace; font-size: 2rem; letter-spacing: 5px; 
    background: rgba(0,0,0,0.3); padding: 10px 20px; border-radius: 8px; 
    min-width: 150px; text-align: center; border: 1px solid rgba(255,255,255,0.1);
    min-height: 60px; color: var(--accent);
}

/* --- PROSIGNS TABLE --- */
.prosigns-table {
    width: 100%;
    border-collapse: separate;
    border-spacing: 0 10px;
    margin-top: 10px;
}
.prosigns-table th {
    text-align: left;
    color: var(--accent);
    text-transform: uppercase;
    font-size: 0.9rem;
    padding: 0 15px;
}
.prosigns-table tr.row-item {
    background: rgba(255,255,255,0.05);
}
.prosigns-table td {
    padding: 15px;
    border-top: 1px solid rgba(255,255,255,0.05);
    border-bottom: 1px solid rgba(255,255,255,0.05);
}
.prosigns-table td:first-child {
    border-left: 1px solid rgba(255,255,255,0.05);
    border-top-left-radius: 10px;
    border-bottom-left-radius: 10px;
    font-weight: bold;
    color: var(--gold);
    width: 30%;
    font-family: monospace;
    font-size: 1.1rem;
}
.prosigns-table td:last-child {
    border-right: 1px solid rgba(255,255,255,0.05);
    border-top-right-radius: 10px;
    border-bottom-right-radius: 10px;
    color: var(--text-main);
}
.overbar {
    text-decoration: overline;
}

/* --- KEYER BUTTON (SEND MODE) --- */
#keyer-btn {
    width: 100%; height: 100px;
    background: linear-gradient(180deg, rgba(255,255,255,0.1), rgba(255,255,255,0.05));
    border: 1px solid rgba(255,255,255,0.1); border-radius: 12px;
    color: var(--text-main); font-size: 1.2rem; font-weight: bold;
    display: flex; flex-direction: column; justify-content: center; align-items: center;
    cursor: pointer; user-select: none; -webkit-tap-highlight-color: transparent;
    transition: all 0.1s; position: relative; overflow: hidden;
    margin-top: 20px;
}
#keyer-btn:active, #keyer-btn.pressed { background: rgba(255,255,255,0.15); transform: scale(0.98); border-color: var(--accent); }
#keyer-sub { font-size: 0.8rem; opacity: 0.7; margin-top: 5px; font-weight: normal; }
.press-progress {
    width: 100%; height: 6px; background: rgba(0,0,0,0.5); border-radius: 3px; margin-top: 15px; overflow: hidden;
}
.press-bar { height: 100%; width: 0%; background: var(--accent); transition: width 0s; }

/* --- GENERIC UI ELEMENTS --- */
.grid-options { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 15px; margin-top: 20px; }
.option-btn {
    background: linear-gradient(145deg, rgba(255,255,255,0.07) 0%, rgba(255,255,255,0.03) 100%);
    backdrop-filter: blur(10px); border: 1px solid rgba(255,255,255,0.08);
    color: var(--text-main); padding: 16px 20px; border-radius: 12px;
    text-align: left; cursor: pointer; display: flex; align-items: center; transition: all 0.2s;
}
.option-btn:hover { background: rgba(255,255,255,0.1); transform: translateY(-2px); border-color: var(--accent); }
.option-btn.correct { background: rgba(74, 222, 128, 0.25); border-color: var(--success); }
.option-btn.wrong { background: rgba(248, 113, 113, 0.25); border-color: var(--error); }

.btn {
    display: inline-block; background: linear-gradient(135deg, #38bdf8 0%, #0284c7 100%);
    color: white; border: none; padding: 12px 28px; font-size: 1rem; font-weight: 700;
    border-radius: 50px; cursor: pointer; transition: all 0.3s; text-transform: uppercase;
    box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
}
.btn:hover { filter: brightness(1.1); transform: translateY(-2px); }
.btn-outline { background: transparent; border: 2px solid rgba(56, 189, 248, 0.5); color: var(--accent); box-shadow: none; }
.btn-outline:hover { background: rgba(56, 189, 248, 0.1); border-color: var(--accent); }
.btn-danger { background: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%); box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4); }
.btn-success { background: linear-gradient(135deg, #22c55e 0%, #15803d 100%); box-shadow: 0 4px 15px rgba(34, 197, 94, 0.4); }

.pill-selector { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 10px; }
.pill {
    padding: 10px 18px; background: rgba(255,255,255,0.05); border-radius: 20px;
    cursor: pointer; border: 1px solid rgba(255,255,255,0.05); transition: all 0.2s; font-size: 0.9rem;
}
.pill.active { background: var(--accent); color: #0f172a; font-weight: 700; border-color: var(--accent); }
.settings-group { margin-bottom: 25px; }
.settings-group label { display: block; margin-bottom: 5px; color: var(--text-muted); font-size: 0.9rem; font-weight: 600; text-transform: uppercase; }

/* --- INPUTS --- */
input[type="text"] {
    width: 100%; padding: 16px; border-radius: 12px; border: 2px solid rgba(255,255,255,0.1);
    background: rgba(15, 23, 42, 0.8); color: white; font-size: 1.1rem; outline: none; margin-bottom: 10px;
}
input[type="text"]:focus { border-color: var(--accent); }

/* --- MORSE BUTTON GRID --- */
.morse-tap-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; width: 100%; }
.morse-tap-btn { font-size: 2rem; padding: 20px; font-weight: bold; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 12px; cursor: pointer; user-select: none; }
.morse-tap-btn:active { background: var(--accent); color: #0f172a; }

.feedback-text { text-align: center; height: 30px; font-weight: bold; margin-top: 15px; font-size: 1.1rem; }
.nav-buttons { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }

/* --- RESULTS PAGE STYLES --- */
.result-item {
    display: flex; align-items: center; gap: 15px;
    background: rgba(255,255,255,0.03);
    padding: 12px; margin-bottom: 10px;
    border-radius: 10px;
    border-left: 4px solid var(--text-muted);
}
.result-item.r-correct { border-left-color: var(--success); background: linear-gradient(90deg, rgba(74,222,128,0.05) 0%, transparent 100%); }
.result-item.r-wrong { border-left-color: var(--error); background: linear-gradient(90deg, rgba(248,113,113,0.05) 0%, transparent 100%); }

.result-mini-flag svg { height: 40px; width: auto; display: block; filter: drop-shadow(0 2px 4px rgba(0,0,0,0.5)); }
.result-mini-morse { 
    width: 40px; height: 40px; display: flex; align-items: center; justify-content: center;
    font-weight: 900; font-size: 1.5rem; color: var(--accent); background: rgba(255,255,255,0.05);
    border-radius: 8px; border: 1px solid rgba(255,255,255,0.1);
}
.result-info { flex: 1; font-size: 0.95rem; }
.result-info .user-ans { font-style: italic; color: var(--error); font-size: 0.85rem; margin-top: 2px; }
.result-info .real-ans { color: var(--success); font-size: 0.85rem; font-weight: 600; }

</style>
</head>
<body>

<script>
// --- FLAGS DATA ---
const DATA_LETTERS = {
    "A": { labelLong: "A ‚Äî Alpha", labelShort: "Alpha", primary: "I have a diver down; keep well clear at slow speed." },
    "B": { labelLong: "B ‚Äî Bravo", labelShort: "Bravo", primary: "I am taking in, or discharging or carrying dangerous goods." },
    "C": { labelLong: "C ‚Äî Charlie", labelShort: "Charlie", primary: "Yes (Affirmative)." },
    "D": { labelLong: "D ‚Äî Delta", labelShort: "Delta", primary: "Keep clear of me; I am manoeuvring with difficulty." },
    "E": { labelLong: "E ‚Äî Echo", labelShort: "Echo", primary: "I am altering my course to Starboard." },
    "F": { labelLong: "F ‚Äî Foxtrot", labelShort: "Foxtrot", primary: "I am disabled; communicate with me." },
    "G": { labelLong: "G ‚Äî Golf", labelShort: "Golf", primary: "I require a pilot. (Fishing: I am hauling nets)." },
    "H": { labelLong: "H ‚Äî Hotel", labelShort: "Hotel", primary: "I have a pilot on board." },
    "I": { labelLong: "I ‚Äî India", labelShort: "India", primary: "I am altering my course to Port." },
    "J": { labelLong: "J ‚Äî Juliet", labelShort: "Juliet", primary: "Keep clear of me. I am on fire and have dangerous cargo on board." },
    "K": { labelLong: "K ‚Äî Kilo", labelShort: "Kilo", primary: "I wish to communicate with you." },
    "L": { labelLong: "L ‚Äî Lima", labelShort: "Lima", primary: "You should stop your vessel instantly." },
    "M": { labelLong: "M ‚Äî Mike", labelShort: "Mike", primary: "My vessel is stopped and making no way through the water." },
    "N": { labelLong: "N ‚Äî November", labelShort: "November", primary: "No (Negative)." },
    "O": { labelLong: "O ‚Äî Oscar", labelShort: "Oscar", primary: "Man overboard." },
    "P": { labelLong: "P ‚Äî Papa", labelShort: "Papa", primary: "In Harbour: All persons should report on board. (Fishing: Nets caught)." },
    "Q": { labelLong: "Q ‚Äî Quebec", labelShort: "Quebec", primary: "My vessel is healthy and I request free pratique." },
    "R": { labelLong: "R ‚Äî Romeo", labelShort: "Romeo", primary: "No single letter meaning." },
    "S": { labelLong: "S ‚Äî Sierra", labelShort: "Sierra", primary: "I am operating astern propulsion." },
    "T": { labelLong: "T ‚Äî Tango", labelShort: "Tango", primary: "Keep clear of me; I am engaged in pair trawling." },
    "U": { labelLong: "U ‚Äî Uniform", labelShort: "Uniform", primary: "You are running into danger." },
    "V": { labelLong: "V ‚Äî Victor", labelShort: "Victor", primary: "I require assistance." },
    "W": { labelLong: "W ‚Äî Whiskey", labelShort: "Whiskey", primary: "I require medical assistance." },
    "X": { labelLong: "X ‚Äî X-ray", labelShort: "X-ray", primary: "Stop carrying out your intentions and watch for my signals." },
    "Y": { labelLong: "Y ‚Äî Yankee", labelShort: "Yankee", primary: "I am dragging my anchor." },
    "Z": { labelLong: "Z ‚Äî Zulu", labelShort: "Zulu", primary: "I require a tug. (Fishing: I am shooting nets)." }
};

const DATA_NUMERALS = {
    "0": { labelLong: "0 ‚Äî Numeral Zero", labelShort: "Zero", primary: "Numeral 0" },
    "1": { labelLong: "1 ‚Äî Numeral One", labelShort: "One", primary: "Numeral 1" },
    "2": { labelLong: "2 ‚Äî Numeral Two", labelShort: "Two", primary: "Numeral 2" },
    "3": { labelLong: "3 ‚Äî Numeral Three", labelShort: "Three", primary: "Numeral 3" },
    "4": { labelLong: "4 ‚Äî Numeral Four", labelShort: "Four", primary: "Numeral 4" },
    "5": { labelLong: "5 ‚Äî Numeral Five", labelShort: "Five", primary: "Numeral 5" },
    "6": { labelLong: "6 ‚Äî Numeral Six", labelShort: "Six", primary: "Numeral 6" },
    "7": { labelLong: "7 ‚Äî Numeral Seven", labelShort: "Seven", primary: "Numeral 7" },
    "8": { labelLong: "8 ‚Äî Numeral Eight", labelShort: "Eight", primary: "Numeral 8" },
    "9": { labelLong: "9 ‚Äî Numeral Nine", labelShort: "Nine", primary: "Numeral 9" }
};

const DATA_SUBS = {
    "SUB1": { labelLong: "1st Substitute", labelShort: "1st Sub", primary: "Repeats the uppermost signal flag of that class." },
    "SUB2": { labelLong: "2nd Substitute", labelShort: "2nd Sub", primary: "Repeats the second flag of that class." },
    "SUB3": { labelLong: "3rd Substitute", labelShort: "3rd Sub", primary: "Repeats the third flag of that class." },
    "ANS":  { labelLong: "Code and Answering Pendant", labelShort: "Ans Pendant", primary: "Decimal point or End of message." }
};

const DATA_SECONDARY = [
    { id: "A_sec", letter: "A", complement: "With 3 numerals", meaning: "AZIMUTH or BEARING" },
    { id: "C_sec", letter: "C", complement: "(Alone)", meaning: "COURSE" },
    { id: "D_sec", letter: "D", complement: "With 2, 4, or 6 numerals", meaning: "DATE" },
    { id: "G_sec", letter: "G", complement: "With 4 or 5 numerals", meaning: "LONGITUDE" },
    { id: "L_sec", letter: "L", complement: "With 4 numerals", meaning: "LATITUDE" },
    { id: "R_sec", letter: "R", complement: "With 1 or more numerals", meaning: "DISTANCE (NM)" },
    { id: "S_sec", letter: "S", complement: "With 1 or more numerals", meaning: "SPEED (Knots)" },
    { id: "T_sec", letter: "T", complement: "With 4 numerals", meaning: "TIME (Local)" },
    { id: "V_sec", letter: "V", complement: "With 1 or more numerals", meaning: "SPEED (Kph)" },
    { id: "Z_sec", letter: "Z", complement: "With 4 numerals", meaning: "TIME (UTC/GMT)" },
    { id: "G_fish", letter: "G", complement: "(Fishing)", meaning: "I am hauling nets" },
    { id: "P_fish", letter: "P", complement: "(Fishing)", meaning: "My nets are caught fast" },
    { id: "Z_fish", letter: "Z", complement: "(Fishing)", meaning: "I am shooting nets" }
];

const ALL_FLAGS = { ...DATA_LETTERS, ...DATA_NUMERALS, ...DATA_SUBS };

// --- MORSE DATA ---
const MORSE_MAP = {
    "A": ".-",    "B": "-...",  "C": "-.-.",  "D": "-..",   "E": ".",
    "F": "..-.",  "G": "--.",   "H": "....",  "I": "..",    "J": ".---",
    "K": "-.-",   "L": ".-..",  "M": "--",    "N": "-.",    "O": "---",
    "P": ".--.",  "Q": "--.-",  "R": ".-.",   "S": "...",   "T": "-",
    "U": "..-",   "V": "...-",  "W": ".--",   "X": "-..-",  "Y": "-.--",
    "Z": "--..",
    "0": "-----", "1": ".----", "2": "..---", "3": "...--", "4": "....-",
    "5": ".....", "6": "-....", "7": "--...", "8": "---..", "9": "----."
};

const LIMITED_LETTERS = ["X","Y","Z","F","Q","L","J"];
const NUMBERS_ARR = ["0","1","2","3","4","5","6","7","8","9"];
const ALL_LETTERS_ARR = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");

// --- PROSIGNS DATA ---
const PROSIGNS = [
    { code: "AA", bar: true, meaning: "Unknown station call / General call" },
    { code: "EEEE...", bar: false, meaning: "Erase (error)" },
    { code: "AAA", bar: false, meaning: "Full stop / Decimal point" },
    { code: "TTTT", bar: false, meaning: "Answering signal" },
    { code: "T", bar: false, meaning: "Word or group received" },
    { code: "AR", bar: false, meaning: "Ending signal / End of transmission" },
    { code: "AS", bar: false, meaning: "Wait" },
    { code: "DE", bar: false, meaning: "From... / This is..." },
    { code: "K", bar: false, meaning: "Invitation to transmit" },
    { code: "OK", bar: false, meaning: "It is correct" },
    { code: "R", bar: false, meaning: "Received" },
    { code: "RQ", bar: false, meaning: "Request / Question" },
    { code: "RPT", bar: false, meaning: "Repeat (whole signal)" },
    { code: "RPT AA", bar: false, meaning: "Repeat All After..." },
    { code: "RPT AB", bar: false, meaning: "Repeat All Before..." },
    { code: "RPT BN", bar: false, meaning: "Repeat All Between..." },
    { code: "RPT WA", bar: false, meaning: "Repeat Word After..." },
    { code: "RPT WB", bar: false, meaning: "Repeat Word Before..." }
];
</script>

<div class="container" id="app">

    <div id="screen-home" class="card">
        <h1>Maritime Mastery</h1>
        <p style="text-align:center; color: var(--text-muted); margin-bottom:10px;">Learn International Signals</p>
        
        <div class="mode-select-grid three-items">
            <div class="big-mode-btn" onclick="goToFlagSetup()">
                <div class="big-mode-icon">üö©</div>
                <div class="big-mode-title">Flags</div>
                <div class="big-mode-desc">Visual quiz</div>
            </div>
            <div class="big-mode-btn" onclick="goToMorseSetup()">
                <div class="big-mode-icon">üì°</div>
                <div class="big-mode-title">Morse</div>
                <div class="big-mode-desc">Tap & Keyer</div>
            </div>
            <div class="big-mode-btn full-width" onclick="goToProsigns()">
                <div class="big-mode-icon">üìñ</div>
                <div class="big-mode-title">Prosigns</div>
                <div class="big-mode-desc">Procedure Reference</div>
            </div>
        </div>

        <div class="footer-credit">MADE BY GEORGE</div>
    </div>

    <div id="screen-flags-setup" class="card hidden">
        <h3>Flag Quiz Setup</h3>
        
        <div class="settings-group">
            <label>Mode</label>
            <div class="pill-selector" id="flag-mode-selector">
                <div class="pill active" onclick="setFlagMode('CHAR')">Identify Flag</div>
                <div class="pill" onclick="setFlagMode('MEANING_MC')">Meaning (MC)</div>
                <div class="pill" onclick="setFlagMode('MEANING_TYPE')">Meaning (Type)</div>
                <div class="pill" onclick="setFlagMode('SECONDARY')">Secondary Meanings</div>
            </div>
        </div>

        <div class="settings-group" id="flag-cats-group">
            <label>Categories</label>
            <div class="pill-selector">
                <div class="pill active pill-check" onclick="toggleFlagCat('letters', this)">Letters</div>
                <div class="pill pill-check" onclick="toggleFlagCat('numerals', this)">Numerals</div>
                <div class="pill pill-check" onclick="toggleFlagCat('subs', this)">Substitutes</div>
            </div>
        </div>

        <div class="settings-group">
            <label>Options</label>
            <div class="pill-selector">
                <div id="btn-flag-autonext" class="pill" onclick="toggleFlagAutoNext()">Auto-Next: OFF</div>
            </div>
        </div>

        <div class="settings-group">
            <label>Count</label>
            <div class="pill-selector" id="flag-count-selector">
                <div class="pill active" onclick="setFlagCount(10)">10</div>
                <div class="pill" onclick="setFlagCount(20)">20</div>
                <div class="pill" onclick="setFlagCount(999)">Endless</div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px; display:flex; justify-content:center; gap:15px;">
            <button class="btn btn-outline" onclick="goHome()">Back</button>
            <button class="btn" onclick="startFlagGame()">Start Quiz</button>
        </div>
    </div>

    <div id="screen-flags-game" class="hidden">
        <div class="hud-dashboard">
            <div class="hud-top-row">
                <span id="flag-hud-progress">Question 1/10</span>
                <span>FLAGS</span>
            </div>
            <div class="hud-stats-row">
                <div id="flag-chip-streak" class="stat-chip chip-streak"><span>üî•</span><span id="flag-val-streak">0</span></div>
                <div class="stat-chip chip-acc"><span>üéØ</span><span id="flag-val-acc">100%</span></div>
            </div>
        </div>

        <div class="card">
            <div class="flag-stage" id="flag-stage">
                <div id="complement-badge" class="complement-text hidden"></div>
            </div>
            <div id="flag-q-text" style="text-align:center; margin-bottom:20px; font-weight:bold; font-size:1.1rem; color:var(--text-muted);">
                Identify this signal
            </div>
            <div id="flag-options-grid" class="grid-options hidden"></div>
            <div id="flag-typing-area" class="hidden">
                <input type="text" id="flag-type-input" placeholder="Type meaning here..." autocomplete="off">
                <div style="text-align:center; margin-top:10px;">
                    <button class="btn" onclick="submitFlagType()">Submit</button>
                </div>
                <div id="flag-feedback-box" class="hidden typing-feedback"></div>
            </div>
            <div id="flag-controls" class="nav-buttons hidden">
                <button class="btn btn-outline" onclick="nextFlagQ()">Next Question</button>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-danger" onclick="endGame('flags')">Finish & Review</button>
        </div>
    </div>

    <div id="screen-morse-setup" class="card hidden">
        <h3>Morse Trainer Setup</h3>
        
        <div class="settings-group">
            <label>Input Mode</label>
            <div class="pill-selector" id="morse-mode-selector">
                <div class="pill active" onclick="setMorseMode('tap')">Tap Buttons</div>
                <div class="pill" onclick="setMorseMode('send')">Send (Keyer)</div>
            </div>
        </div>

        <div class="settings-group">
            <label>Character Set</label>
            <div class="pill-selector" id="morse-set-selector">
                <div class="pill active" onclick="setMorseSet('limited')">Easy (X Y Z F Q L J)</div>
                <div class="pill" onclick="setMorseSet('nums')">Numbers</div>
                <div class="pill" onclick="setMorseSet('all')">All Letters</div>
            </div>
        </div>

        <div class="settings-group">
            <label>Options</label>
            <div class="pill-selector">
                <div id="btn-morse-autonext" class="pill" onclick="toggleMorseAutoNext()">Auto-Next: OFF</div>
                <div id="btn-morse-sound" class="pill active" onclick="toggleMorseSound()">Sound: ON</div>
            </div>
        </div>

        <div style="text-align: center; margin-top: 40px; display:flex; justify-content:center; gap:15px;">
            <button class="btn btn-outline" onclick="goHome()">Back</button>
            <button class="btn" onclick="startMorseGame()">Start Practice</button>
        </div>
    </div>

    <div id="screen-morse-game" class="hidden">
        <div class="hud-dashboard">
            <div class="hud-top-row">
                <span>MORSE PRACTICE</span>
                <span id="morse-mode-label" style="color:var(--accent);">TAP MODE</span>
            </div>
            <div class="hud-stats-row">
                <div id="morse-chip-streak" class="stat-chip chip-streak"><span>üî•</span><span id="morse-val-streak">0</span></div>
                <div id="morse-chip-wpm" class="stat-chip chip-wpm hidden"><span>üì∂</span><span id="morse-val-wpm">-- WPM</span></div>
            </div>
        </div>

        <div class="card">
            <div class="morse-stage">
                <div id="morse-target-char" class="morse-big-char">?</div>
                <div id="morse-user-input" class="morse-display-code"></div>
            </div>

            <div id="morse-tap-controls" class="hidden">
                <div class="morse-tap-grid">
                    <button class="morse-tap-btn" onmousedown="tapDot()" ontouchstart="tapDot()">‚óè</button>
                    <button class="morse-tap-btn" onmousedown="tapDash()" ontouchstart="tapDash()">‚ñ¨</button>
                </div>
            </div>

            <div id="morse-send-controls" class="hidden">
                <div id="keyer-btn">
                    KEY
                    <div id="keyer-sub">Hold for Dash</div>
                    <div class="press-progress"><div id="press-bar" class="press-bar"></div></div>
                </div>
            </div>

            <div id="morse-feedback" class="feedback-text"></div>

            <div class="nav-buttons" id="morse-nav-area">
                <button class="btn btn-outline" onclick="morseBackspace()">Back</button>
                <button class="btn btn-outline" onclick="morseClear()">Clear</button>
                <button id="btn-morse-check" class="btn" onclick="checkMorse()">Check</button>
            </div>
        </div>
        <div class="nav-buttons">
            <button class="btn btn-danger" onclick="endGame('morse')">Finish & Review</button>
        </div>
    </div>

    <div id="screen-prosigns" class="card hidden">
        <h3>Procedure Signals (Prosigns)</h3>
        <table class="prosigns-table" id="prosigns-table">
            <thead>
                <tr>
                    <th>Signal</th>
                    <th>Meaning</th>
                </tr>
            </thead>
            <tbody id="prosigns-tbody">
                </tbody>
        </table>
        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="goHome()">Back to Menu</button>
        </div>
    </div>

    <div id="screen-results" class="card hidden">
        <h1>Results</h1>
        <div style="text-align: center; margin-bottom: 30px;">
            <div style="font-size: 4rem; font-weight: 800; color: var(--accent); text-shadow: 0 0 20px rgba(14,165,233,0.5);" id="final-score-percent">0%</div>
            <div style="color: var(--text-muted); font-size: 1.2rem;" id="final-score-text">0 out of 0 correct</div>
        </div>

        <h3 style="text-align: left; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 10px;">Review</h3>
        <div id="review-list"></div>

        <div style="text-align: center; margin-top: 30px;">
            <button class="btn" onclick="goHome()">Back to Menu</button>
        </div>
    </div>

</div>

<script>
// --- AUDIO ENGINE ---
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
let osc = null;
let gainNode = null;

function initAudio() {
    if (!audioCtx) {
        audioCtx = new AudioContext();
    }
    if (audioCtx.state === 'suspended') {
        audioCtx.resume();
    }
}

function playTone() {
    if (!appState.morse.soundEnabled) return;
    initAudio();
    if (osc) return; 

    osc = audioCtx.createOscillator();
    gainNode = audioCtx.createGain();
    
    osc.type = 'sine';
    osc.frequency.setValueAtTime(600, audioCtx.currentTime); 
    
    gainNode.gain.setValueAtTime(0, audioCtx.currentTime);
    gainNode.gain.linearRampToValueAtTime(0.1, audioCtx.currentTime + 0.01); 
    
    osc.connect(gainNode);
    gainNode.connect(audioCtx.destination);
    osc.start();
}

function stopTone() {
    if (osc) {
        const now = audioCtx.currentTime;
        gainNode.gain.cancelScheduledValues(now);
        gainNode.gain.setValueAtTime(gainNode.gain.value, now);
        gainNode.gain.linearRampToValueAtTime(0, now + 0.01); 
        osc.stop(now + 0.01);
        osc = null;
    }
}

function playBeep(duration) {
    if (!appState.morse.soundEnabled) return;
    initAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = 'sine';
    o.frequency.value = 600;
    g.gain.setValueAtTime(0.1, audioCtx.currentTime);
    o.connect(g);
    g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + (duration / 1000));
}

// --- GLOBAL STATE ---
let appState = {
    screen: 'HOME',
    flags: {
        mode: 'CHAR',
        cats: { letters: true, numerals: false, subs: false },
        count: 10,
        autoNext: false,
        qList: [],
        currIdx: 0,
        score: 0,
        streak: 0,
        waiting: false,
        history: []
    },
    morse: {
        mode: 'tap',
        set: 'limited',
        autoNext: false,
        soundEnabled: true,
        pool: [],
        target: '',
        typed: '',
        streak: 0,
        ditEma: null,
        pressStart: 0,
        pressActive: false,
        waiting: false,
        history: [],
        correctCount: 0,
        wrongCount: 0
    }
};

function hideAllScreens() {
    ['screen-home', 'screen-flags-setup', 'screen-flags-game', 'screen-morse-setup', 'screen-morse-game', 'screen-prosigns', 'screen-results'].forEach(id => {
        document.getElementById(id).classList.add('hidden');
    });
}

function goHome() {
    hideAllScreens();
    document.getElementById('screen-home').classList.remove('hidden');
    if(pressAnim) cancelAnimationFrame(pressAnim);
    stopTone();
}

// ==========================================
//              FLAGS LOGIC
// ==========================================

function goToFlagSetup() {
    hideAllScreens();
    document.getElementById('screen-flags-setup').classList.remove('hidden');
}

function setFlagMode(m) {
    appState.flags.mode = m;
    updatePills('flag-mode-selector', m === 'CHAR' ? 0 : m === 'MEANING_MC' ? 1 : m === 'MEANING_TYPE' ? 2 : 3);
    const catGroup = document.getElementById('flag-cats-group');
    if (m === 'SECONDARY') catGroup.classList.add('hidden');
    else catGroup.classList.remove('hidden');
}

function toggleFlagCat(cat, el) {
    appState.flags.cats[cat] = !appState.flags.cats[cat];
    if(!appState.flags.cats.letters && !appState.flags.cats.numerals && !appState.flags.cats.subs) {
        appState.flags.cats[cat] = true; 
    }
    el.classList.toggle('active');
}

function toggleFlagAutoNext() {
    appState.flags.autoNext = !appState.flags.autoNext;
    const btn = document.getElementById('btn-flag-autonext');
    btn.innerText = `Auto-Next: ${appState.flags.autoNext ? 'ON' : 'OFF'}`;
    btn.classList.toggle('active');
}

function setFlagCount(c) {
    appState.flags.count = c;
    const pills = document.getElementById('flag-count-selector').children;
    for(let p of pills) p.classList.remove('active');
    event.target.classList.add('active');
}

function updatePills(parentId, activeIdx) {
    const p = document.getElementById(parentId).children;
    for(let i=0; i<p.length; i++) p[i].classList.remove('active');
    p[activeIdx].classList.add('active');
}

function startFlagGame() {
    let pool = [];
    if (appState.flags.mode === 'SECONDARY') {
        pool = DATA_SECONDARY.map(item => ({...item, type: 'secondary'}));
    } else {
        if (appState.flags.cats.letters) pool.push(...Object.keys(DATA_LETTERS).map(k => ({id: k, ...DATA_LETTERS[k]})));
        if (appState.flags.cats.numerals) pool.push(...Object.keys(DATA_NUMERALS).map(k => ({id: k, ...DATA_NUMERALS[k]})));
        if (appState.flags.cats.subs) pool.push(...Object.keys(DATA_SUBS).map(k => ({id: k, ...DATA_SUBS[k]})));
    }
    
    pool.sort(() => Math.random() - 0.5);
    if(appState.flags.count !== 999) pool = pool.slice(0, appState.flags.count);
    
    appState.flags.qList = pool;
    appState.flags.currIdx = 0;
    appState.flags.score = 0;
    appState.flags.streak = 0;
    appState.flags.waiting = false;
    appState.flags.history = [];

    hideAllScreens();
    document.getElementById('screen-flags-game').classList.remove('hidden');
    loadFlagQ();
}

function loadFlagQ() {
    if(appState.flags.currIdx >= appState.flags.qList.length && appState.flags.count !== 999) {
        endGame('flags');
        return;
    }

    appState.flags.waiting = false;
    const q = appState.flags.qList[appState.flags.currIdx % appState.flags.qList.length];
    
    document.getElementById('flag-hud-progress').innerText = `Question ${appState.flags.currIdx + 1} / ${appState.flags.count === 999 ? '‚àû' : appState.flags.count}`;
    document.getElementById('flag-val-streak').innerText = appState.flags.streak;
    document.getElementById('flag-val-acc').innerText = appState.flags.currIdx === 0 ? '100%' : Math.round((appState.flags.score / appState.flags.currIdx) * 100) + '%';
    
    if (appState.flags.streak >= 3) document.getElementById('flag-chip-streak').classList.add('hot');
    else document.getElementById('flag-chip-streak').classList.remove('hot');

    const flagId = q.type === 'secondary' ? q.letter : q.id;
    document.getElementById('flag-stage').innerHTML = renderFlag(flagId) + `<div id="complement-badge" class="complement-text hidden"></div>`;
    
    const compBadge = document.getElementById('complement-badge');
    if (q.type === 'secondary') {
        compBadge.innerText = "+ " + q.complement;
        compBadge.classList.remove('hidden');
    } else {
        compBadge.classList.add('hidden');
    }

    const grid = document.getElementById('flag-options-grid');
    const typeArea = document.getElementById('flag-typing-area');
    const controls = document.getElementById('flag-controls');
    const feedback = document.getElementById('flag-feedback-box');
    
    grid.classList.add('hidden');
    typeArea.classList.add('hidden');
    controls.classList.add('hidden');
    feedback.classList.add('hidden');
    
    const qText = document.getElementById('flag-q-text');

    if(appState.flags.mode === 'CHAR') {
        qText.innerText = "Identify this flag";
        grid.classList.remove('hidden');
        generateFlagOptions(q, 'labelShort');
    } else if(appState.flags.mode === 'MEANING_MC') {
        qText.innerText = `What is the meaning of ${q.labelShort}?`;
        grid.classList.remove('hidden');
        generateFlagOptions(q, 'primary');
    } else if (appState.flags.mode === 'SECONDARY') {
        qText.innerText = `Meaning with complement: "${q.complement}"`;
        grid.classList.remove('hidden');
        generateFlagOptions(q, 'meaning');
    } else {
        qText.innerText = `Type meaning of ${q.labelShort}`;
        typeArea.classList.remove('hidden');
        document.getElementById('flag-type-input').value = "";
        document.getElementById('flag-type-input').focus();
    }
}

function generateFlagOptions(correct, field) {
    const grid = document.getElementById('flag-options-grid');
    grid.innerHTML = "";
    
    let pool = [];
    if (appState.flags.mode === 'SECONDARY') {
        pool = DATA_SECONDARY.filter(x => x.id !== correct.id);
    } else {
        const all = Object.values(ALL_FLAGS).filter(x => x.labelLong !== correct.labelLong);
        pool = all;
    }

    pool.sort(() => Math.random() - 0.5);
    const opts = [correct, ...pool.slice(0, 3)];
    opts.sort(() => Math.random() - 0.5);
    
    opts.forEach(opt => {
        const btn = document.createElement('div');
        btn.className = 'option-btn';
        btn.innerText = opt[field];
        btn.onclick = () => checkFlagMC(opt, btn);
        grid.appendChild(btn);
    });
}

function checkFlagMC(selected, btn) {
    if (appState.flags.waiting) return;

    const correct = appState.flags.qList[appState.flags.currIdx % appState.flags.qList.length];
    let isCorrect = false;

    if (appState.flags.mode === 'SECONDARY') {
        isCorrect = selected.id === correct.id;
    } else {
        isCorrect = selected.labelLong === correct.labelLong;
    }

    let realAnsText = appState.flags.mode === 'CHAR' ? correct.labelShort : (appState.flags.mode === 'SECONDARY' ? correct.meaning : correct.primary);
    let userAnsText = appState.flags.mode === 'CHAR' ? selected.labelShort : (appState.flags.mode === 'SECONDARY' ? selected.meaning : selected.primary);
    
    appState.flags.history.push({
        q: correct,
        correct: isCorrect,
        userAns: userAnsText,
        realAns: realAnsText
    });

    if(isCorrect) {
        btn.classList.add('correct');
        appState.flags.score++;
        appState.flags.streak++;
        
        if (appState.flags.autoNext) {
            appState.flags.waiting = true;
            setTimeout(nextFlagQ, 900);
            return;
        }
    } else {
        btn.classList.add('wrong');
        appState.flags.streak = 0;
        Array.from(document.getElementById('flag-options-grid').children).forEach(child => {
            if(child.innerText === realAnsText) child.classList.add('correct');
        });
    }
    document.getElementById('flag-controls').classList.remove('hidden');
}

function submitFlagType() {
    if (appState.flags.waiting) return;
    
    const input = document.getElementById('flag-type-input').value.toLowerCase();
    const correct = appState.flags.qList[appState.flags.currIdx % appState.flags.qList.length];
    
    const keywords = correct.primary.toLowerCase().split(' ').filter(w => w.length > 3);
    const match = keywords.some(k => input.includes(k));
    
    const isCorrect = (match || input === correct.primary.toLowerCase());
    
    appState.flags.history.push({
        q: correct,
        correct: isCorrect,
        userAns: input,
        realAns: correct.primary
    });

    const fb = document.getElementById('flag-feedback-box');
    fb.classList.remove('hidden');
    
    if(isCorrect) {
        fb.innerHTML = "<span style='color:var(--success)'>Correct!</span>";
        appState.flags.score++;
        appState.flags.streak++;
        
        if (appState.flags.autoNext) {
            appState.flags.waiting = true;
            setTimeout(nextFlagQ, 1000);
            return;
        }
    } else {
        fb.innerHTML = `<span style='color:var(--error)'>Incorrect.</span><br><small>${correct.primary}</small>`;
        appState.flags.streak = 0;
    }
    document.getElementById('flag-controls').classList.remove('hidden');
}

function nextFlagQ() {
    appState.flags.currIdx++;
    loadFlagQ();
}


// ==========================================
//              MORSE LOGIC
// ==========================================

function goToMorseSetup() {
    hideAllScreens();
    document.getElementById('screen-morse-setup').classList.remove('hidden');
}

function setMorseMode(m) {
    appState.morse.mode = m;
    updatePills('morse-mode-selector', m === 'tap' ? 0 : 1);
}

function setMorseSet(s) {
    appState.morse.set = s;
    updatePills('morse-set-selector', s === 'limited' ? 0 : s === 'nums' ? 1 : 2);
}

function toggleMorseAutoNext() {
    appState.morse.autoNext = !appState.morse.autoNext;
    const btn = document.getElementById('btn-morse-autonext');
    btn.innerText = `Auto-Next: ${appState.morse.autoNext ? 'ON' : 'OFF'}`;
    btn.classList.toggle('active');
}

function toggleMorseSound() {
    appState.morse.soundEnabled = !appState.morse.soundEnabled;
    const btn = document.getElementById('btn-morse-sound');
    btn.innerText = `Sound: ${appState.morse.soundEnabled ? 'ON' : 'OFF'}`;
    btn.classList.toggle('active');
}

function startMorseGame() {
    let pool = [];
    if(appState.morse.set === 'limited') pool = LIMITED_LETTERS;
    else if(appState.morse.set === 'nums') pool = NUMBERS_ARR;
    else pool = [...ALL_LETTERS_ARR, ...NUMBERS_ARR];
    
    appState.morse.pool = pool;
    appState.morse.streak = 0;
    appState.morse.ditEma = null;
    appState.morse.waiting = false;
    appState.morse.history = [];
    appState.morse.correctCount = 0;
    appState.morse.wrongCount = 0;

    hideAllScreens();
    document.getElementById('screen-morse-game').classList.remove('hidden');
    
    document.getElementById('morse-mode-label').innerText = appState.morse.mode === 'tap' ? 'TAP MODE' : 'SEND MODE';
    document.getElementById('morse-tap-controls').classList.toggle('hidden', appState.morse.mode !== 'tap');
    document.getElementById('morse-send-controls').classList.toggle('hidden', appState.morse.mode !== 'send');
    document.getElementById('morse-chip-wpm').classList.toggle('hidden', appState.morse.mode !== 'send');

    pickMorseChar();
}

function pickMorseChar() {
    const char = appState.morse.pool[Math.floor(Math.random() * appState.morse.pool.length)];
    appState.morse.target = char;
    appState.morse.typed = "";
    appState.morse.waiting = false;
    
    document.getElementById('morse-target-char').innerText = char;
    document.getElementById('morse-user-input').innerText = "";
    document.getElementById('morse-feedback').innerText = "";
    document.getElementById('morse-val-streak').innerText = appState.morse.streak;
    
    // Reset Check Button
    const checkBtn = document.getElementById('btn-morse-check');
    checkBtn.innerText = "Check";
    checkBtn.classList.remove('btn-success');
    
    if(appState.morse.streak >= 3) document.getElementById('morse-chip-streak').classList.add('hot');
    else document.getElementById('morse-chip-streak').classList.remove('hot');
}

function morseInput(symbol) {
    if (appState.morse.waiting) return;
    appState.morse.typed += symbol;
    document.getElementById('morse-user-input').innerText = appState.morse.typed;
}

function tapDot() {
    playBeep(60);
    morseInput('.');
}

function tapDash() {
    playBeep(180);
    morseInput('-');
}

function morseBackspace() {
    if (appState.morse.waiting) return;
    appState.morse.typed = appState.morse.typed.slice(0, -1);
    document.getElementById('morse-user-input').innerText = appState.morse.typed;
}

function morseClear() {
    if (appState.morse.waiting) return;
    appState.morse.typed = "";
    document.getElementById('morse-user-input').innerText = "";
}

function checkMorse() {
    // If waiting (manual next clicked)
    if (appState.morse.waiting) {
        pickMorseChar();
        return;
    }

    const correctCode = MORSE_MAP[appState.morse.target];
    const userCode = appState.morse.typed;
    const feedback = document.getElementById('morse-feedback');
    const isCorrect = (userCode === correctCode);
    const checkBtn = document.getElementById('btn-morse-check');
    
    appState.morse.history.push({
        target: appState.morse.target,
        correctCode: correctCode,
        userCode: userCode,
        correct: isCorrect
    });
    
    if (isCorrect) {
        feedback.innerHTML = "<span style='color:var(--success)'>Correct!</span>";
        appState.morse.streak++;
        appState.morse.correctCount++;
        appState.morse.waiting = true;
        
        if (appState.morse.autoNext) {
            setTimeout(pickMorseChar, 1000);
        } else {
            // Change button to Next for manual advance
            checkBtn.innerText = "Next ‚û°";
            checkBtn.classList.add('btn-success');
        }
    } else {
        feedback.innerHTML = `<span style='color:var(--error)'>Wrong!</span> ${correctCode}`;
        appState.morse.streak = 0;
        appState.morse.wrongCount++;
        appState.morse.typed = ""; 
        document.getElementById('morse-user-input').innerText = "";
        document.getElementById('morse-val-streak').innerText = 0;
        document.getElementById('morse-chip-streak').classList.remove('hot');
    }
}

// --- SEND MODE (KEYER) ---
const DASH_THRESHOLD_MS = 250; 
const EMA_ALPHA = 0.2;
let pressAnim = null;

const keyerBtn = document.getElementById('keyer-btn');
const pressBar = document.getElementById('press-bar');

function pressDown(e) {
    if(appState.morse.mode !== 'send' || appState.morse.waiting) return;
    e.preventDefault();
    if(appState.morse.pressActive) return;
    
    appState.morse.pressActive = true;
    appState.morse.pressStart = performance.now();
    keyerBtn.classList.add('pressed');
    
    playTone(); // Audio start

    const start = performance.now();
    const tick = () => {
        if(!appState.morse.pressActive) return;
        const elapsed = performance.now() - start;
        const pct = Math.min((elapsed / DASH_THRESHOLD_MS) * 100, 100);
        pressBar.style.width = pct + "%";
        pressAnim = requestAnimationFrame(tick);
    };
    pressAnim = requestAnimationFrame(tick);
}

function pressUp(e) {
    if(appState.morse.mode !== 'send' || appState.morse.waiting) return;
    e.preventDefault();
    if(!appState.morse.pressActive) return;
    
    stopTone(); // Audio stop

    appState.morse.pressActive = false;
    keyerBtn.classList.remove('pressed');
    if(pressAnim) cancelAnimationFrame(pressAnim);
    pressBar.style.width = "0%";
    
    const dur = performance.now() - appState.morse.pressStart;
    const sym = (dur >= DASH_THRESHOLD_MS) ? "-" : ".";
    morseInput(sym);
    
    const ditGuess = (sym === ".") ? dur : (dur / 3);
    const old = appState.morse.ditEma;
    appState.morse.ditEma = (old == null) ? ditGuess : (EMA_ALPHA * ditGuess + (1 - EMA_ALPHA) * old);
    
    const wpm = Math.round(1200 / appState.morse.ditEma);
    if(isFinite(wpm) && wpm > 0 && wpm < 60) {
        document.getElementById('morse-val-wpm').innerText = wpm + " WPM";
    }
}

keyerBtn.addEventListener('mousedown', pressDown);
keyerBtn.addEventListener('touchstart', pressDown);
document.addEventListener('mouseup', pressUp);
document.addEventListener('touchend', pressUp);


// ==========================================
//              PROSIGNS LOGIC
// ==========================================
function goToProsigns() {
    hideAllScreens();
    document.getElementById('screen-prosigns').classList.remove('hidden');
    
    const tbody = document.getElementById('prosigns-tbody');
    tbody.innerHTML = "";
    
    PROSIGNS.forEach(item => {
        const tr = document.createElement('tr');
        tr.className = "row-item";
        
        let displayCode = item.code;
        if(item.bar) {
            // Apply overbar to AA
            displayCode = `<span class="overbar">${item.code}</span>`;
        }
        
        tr.innerHTML = `
            <td>${displayCode}</td>
            <td>${item.meaning}</td>
        `;
        tbody.appendChild(tr);
    });
}

// ==========================================
//              RESULTS LOGIC
// ==========================================

function endGame(mode) {
    hideAllScreens();
    document.getElementById('screen-results').classList.remove('hidden');
    
    let total = 0, correct = 0, history = [];
    
    if (mode === 'flags') {
        history = appState.flags.history;
        total = history.length;
        correct = history.filter(h => h.correct).length;
    } else {
        history = appState.morse.history;
        total = history.length;
        correct = history.filter(h => h.correct).length;
    }

    const p = total === 0 ? 0 : Math.round((correct / total) * 100);
    
    document.getElementById('final-score-percent').innerText = `${p}%`;
    document.getElementById('final-score-text').innerText = `${correct} out of ${total} correct`;

    const list = document.getElementById('review-list');
    list.innerHTML = "";
    
    history.forEach(item => {
        const div = document.createElement('div');
        div.className = `result-item ${item.correct ? 'r-correct' : 'r-wrong'}`;
        
        if (mode === 'flags') {
            const flagKey = item.q.type === 'secondary' ? item.q.letter : item.q.id;
            div.innerHTML = `
                <div class="result-mini-flag">${renderFlag(flagKey)}</div>
                <div class="result-info">
                    <div>${item.q.labelShort || item.q.letter}</div>
                    ${!item.correct ? `<div class="user-ans">You: ${item.userAns}</div>` : ''}
                    <div class="real-ans">${item.realAns}</div>
                </div>
            `;
        } else {
            // Morse Review
            div.innerHTML = `
                <div class="result-mini-morse">${item.target}</div>
                <div class="result-info">
                    <div style="letter-spacing:2px; font-weight:bold;">${item.correctCode}</div>
                    ${!item.correct ? `<div class="user-ans">You: ${item.userCode || '(empty)'}</div>` : ''}
                </div>
            `;
        }
        list.appendChild(div);
    });
}

// ==========================================
//              SVG ENGINE
// ==========================================
function renderFlag(key) {
    const W = 300, H = 200;
    const C = { Y: "#facc15", B: "#2563eb", R: "#dc2626", W: "#f8fafc", K: "#1e293b" };
    const uid = key + "_" + Math.floor(Math.random() * 10000);

    let pathD = `M0,0 L300,0 L300,200 L0,200 Z`; 

    if (key === 'A' || key === 'B') {
        pathD = `M0,0 L300,0 L220,100 L300,200 L0,200 Z`; 
    } else if (DATA_NUMERALS[key] || key === 'ANS') {
        pathD = `M0,0 L280,60 L280,140 L0,200 Z`; 
    } else if (key && key.startsWith('SUB')) {
        pathD = `M0,0 L260,100 L0,200 Z`; 
    }

    const clipDef = `<defs><clipPath id="cp_${uid}"><path d="${pathD}"/></clipPath></defs>`;
    let content = "";
    const gClip = `<g clip-path="url(#cp_${uid})">`;
    const gEnd = `</g>`;

    switch(key) {
        case "A": content = gClip + `<rect x="0" y="0" width="120" height="200" fill="${C.W}"/><rect x="120" y="0" width="180" height="200" fill="${C.B}"/>` + gEnd; break;
        case "B": content = gClip + `<rect width="300" height="200" fill="${C.R}"/>` + gEnd; break;
        case "C": content = `<rect y="0" width="300" height="40" fill="${C.B}"/><rect y="40" width="300" height="40" fill="${C.W}"/><rect y="80" width="300" height="40" fill="${C.R}"/><rect y="120" width="300" height="40" fill="${C.W}"/><rect y="160" width="300" height="40" fill="${C.B}"/>`; break;
        case "D": content = `<rect y="0" width="300" height="50" fill="${C.Y}"/><rect y="50" width="300" height="100" fill="${C.B}"/><rect y="150" width="300" height="50" fill="${C.Y}"/>`; break;
        case "E": content = `<rect y="0" width="300" height="100" fill="${C.B}"/><rect y="100" width="300" height="100" fill="${C.R}"/>`; break;
        case "F": content = `<rect width="300" height="200" fill="${C.W}"/><path d="M150,20 L280,100 L150,180 L20,100 Z" fill="${C.R}"/>`; break;
        case "G": content = `<g>`; for(let i=0;i<6;i++) content+=`<rect x="${i*50}" width="50" height="200" fill="${i%2===0?C.Y:C.B}"/>`; content+=`</g>`; break;
        case "H": content = `<rect x="0" width="150" height="200" fill="${C.W}"/><rect x="150" width="150" height="200" fill="${C.R}"/>`; break;
        case "I": content = `<rect width="300" height="200" fill="${C.Y}"/><circle cx="150" cy="100" r="50" fill="${C.K}"/>`; break;
        case "J": content = `<rect y="0" width="300" height="66" fill="${C.B}"/><rect y="66" width="300" height="68" fill="${C.W}"/><rect y="134" width="300" height="66" fill="${C.B}"/>`; break;
        case "K": content = `<rect x="0" width="150" height="200" fill="${C.Y}"/><rect x="150" width="150" height="200" fill="${C.B}"/>`; break;
        case "L": content = `<rect x="0" y="0" width="150" height="100" fill="${C.Y}"/><rect x="150" y="0" width="150" height="100" fill="${C.K}"/><rect x="0" y="100" width="150" height="100" fill="${C.K}"/><rect x="150" y="100" width="150" height="100" fill="${C.Y}"/>`; break;
        case "M": content = `<rect width="300" height="200" fill="${C.B}"/><path d="M0,0 L20,0 L300,180 L300,200 L280,200 L0,20 Z" fill="${C.W}"/><path d="M300,0 L280,0 L0,180 L0,200 L20,200 L300,20 Z" fill="${C.W}"/>`; break;
        case "N": content = `<rect width="300" height="200" fill="${C.W}"/>`; for(let r=0;r<4;r++) for(let c=0;c<4;c++) if((r+c)%2===0) content+=`<rect x="${c*75}" y="${r*50}" width="75" height="50" fill="${C.B}"/>`; break;
        case "O": content = `<rect width="300" height="200" fill="${C.Y}"/><path d="M0,0 L300,0 L0,200 Z" fill="${C.R}"/>`; break;
        case "P": content = `<rect width="300" height="200" fill="${C.B}"/><rect x="100" y="66" width="100" height="68" fill="${C.W}"/>`; break;
        case "Q": content = `<rect width="300" height="200" fill="${C.Y}"/>`; break;
        case "R": content = `<rect width="300" height="200" fill="${C.R}"/><rect x="125" y="0" width="50" height="200" fill="${C.Y}"/><rect x="0" y="75" width="300" height="50" fill="${C.Y}"/>`; break;
        case "S": content = `<rect width="300" height="200" fill="${C.W}"/><rect x="100" y="66" width="100" height="68" fill="${C.B}"/>`; break;
        case "T": content = `<rect x="0" width="100" height="200" fill="${C.R}"/><rect x="100" width="100" height="200" fill="${C.W}"/><rect x="200" width="100" height="200" fill="${C.B}"/>`; break;
        case "U": content = `<rect x="0" y="0" width="150" height="100" fill="${C.R}"/><rect x="150" y="0" width="150" height="100" fill="${C.W}"/><rect x="0" y="100" width="150" height="100" fill="${C.W}"/><rect x="150" y="100" width="150" height="100" fill="${C.R}"/>`; break;
        case "V": content = `<rect width="300" height="200" fill="${C.W}"/><path d="M0,0 L20,0 L300,180 L300,200 L280,200 L0,20 Z" fill="${C.R}"/><path d="M300,0 L280,0 L0,180 L0,200 L20,200 L300,20 Z" fill="${C.R}"/>`; break;
        case "W": content = `<rect width="300" height="200" fill="${C.B}"/><rect x="50" y="33" width="200" height="134" fill="${C.W}"/><rect x="100" y="66" width="100" height="68" fill="${C.R}"/>`; break;
        case "X": content = `<rect width="300" height="200" fill="${C.W}"/><rect x="125" y="0" width="50" height="200" fill="${C.B}"/><rect x="0" y="75" width="300" height="50" fill="${C.B}"/>`; break;
        case "Y": content = `<rect width="300" height="200" fill="${C.Y}"/>`; for(let i=0;i<10;i++) content+=`<path d="M${i*60},0 L${(i*60)+30},0 L0,${(i*60)+30} L0,${i*60} Z" fill="${C.R}"/><path d="M300,${i*60} L300,${(i*60)+30} L${300-((i*60)+30)},0 L${300-(i*60)},0 Z" fill="${C.R}"/>`; break;
        case "Z": content = `<rect x="0" y="0" width="150" height="100" fill="${C.Y}"/><rect x="150" y="0" width="150" height="100" fill="${C.B}"/><rect x="0" y="100" width="150" height="100" fill="${C.R}"/><rect x="150" y="100" width="150" height="100" fill="${C.K}"/>`; break;

        case "1": content = gClip + `<rect width="300" height="200" fill="${C.W}"/><circle cx="100" cy="100" r="45" fill="${C.R}"/>` + gEnd; break;
        case "2": content = gClip + `<rect width="300" height="200" fill="${C.B}"/><circle cx="100" cy="100" r="45" fill="${C.W}"/>` + gEnd; break;
        case "3": content = gClip + `<rect x="0" width="100" height="200" fill="${C.R}"/><rect x="100" width="100" height="200" fill="${C.W}"/><rect x="200" width="100" height="200" fill="${C.B}"/>` + gEnd; break;
        case "4": content = gClip + `<rect width="300" height="200" fill="${C.R}"/><rect x="80" width="40" height="200" fill="${C.W}"/><rect y="80" width="300" height="40" fill="${C.W}"/>` + gEnd; break;
        case "5": content = gClip + `<rect x="0" width="100" height="200" fill="${C.Y}"/><rect x="100" width="200" height="200" fill="${C.B}"/>` + gEnd; break;
        case "6": content = gClip + `<rect y="0" width="300" height="100" fill="${C.K}"/><rect y="100" width="300" height="100" fill="${C.W}"/>` + gEnd; break;
        case "7": content = gClip + `<rect y="0" width="300" height="100" fill="${C.Y}"/><rect y="100" width="300" height="100" fill="${C.R}"/>` + gEnd; break;
        case "8": content = gClip + `<rect width="300" height="200" fill="${C.W}"/><rect x="80" width="40" height="200" fill="${C.R}"/><rect y="80" width="300" height="40" fill="${C.R}"/>` + gEnd; break;
        case "9": content = gClip + `<rect x="0" y="0" width="150" height="100" fill="${C.W}"/><rect x="150" y="0" width="150" height="100" fill="${C.K}"/><rect x="0" y="100" width="150" height="100" fill="${C.R}"/><rect x="150" y="100" width="150" height="100" fill="${C.Y}"/>` + gEnd; break;
        case "0": content = gClip + `<rect x="0" width="100" height="200" fill="${C.Y}"/><rect x="100" width="100" height="200" fill="${C.R}"/><rect x="200" width="100" height="200" fill="${C.Y}"/>` + gEnd; break;

        case "SUB1": content = gClip + `<rect width="300" height="200" fill="${C.B}"/><path d="M0,50 L140,100 L0,150 Z" fill="${C.Y}"/>` + gEnd; break;
        case "SUB2": content = gClip + `<rect x="0" width="150" height="200" fill="${C.B}"/><rect x="150" width="150" height="200" fill="${C.W}"/>` + gEnd; break;
        case "SUB3": content = gClip + `<rect width="300" height="200" fill="${C.W}"/><rect y="80" width="300" height="40" fill="${C.K}"/>` + gEnd; break;
        case "ANS": 
             content = gClip;
             for(let i=0; i<7; i++) content += `<rect x="${i*43}" width="43" height="200" fill="${i%2===0?C.R:C.W}"/>`;
             content += gEnd;
             break;
    }

    const stroke = `<path d="${pathD}" fill="none" stroke="#666" stroke-width="1"/>`;
    return `<svg viewBox="0 0 ${W} ${H}" xmlns="http://www.w3.org/2000/svg">${clipDef}${content}${stroke}</svg>`;
}

</script>
</body>
</html>